'use strict';

exports.__esModule = true;

var _getOwnPropertyDescriptor = require('babel-runtime/core-js/object/get-own-property-descriptor');

var _getOwnPropertyDescriptor2 = _interopRequireDefault(_getOwnPropertyDescriptor);

var _tooltip = require('antd/lib/tooltip');

var _tooltip2 = _interopRequireDefault(_tooltip);

var _button = require('antd/lib/button');

var _button2 = _interopRequireDefault(_button);

var _row = require('antd/lib/row');

var _row2 = _interopRequireDefault(_row);

var _col = require('antd/lib/col');

var _col2 = _interopRequireDefault(_col);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _dec, _class, _desc, _value, _class2, _class3, _temp;

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _reactRedux = require('react-redux');

var _reactRouterDom = require('react-router-dom');

var _project = require('../../../reducer/modules/project');

var _ProjectCard = require('../../../components/ProjectCard/ProjectCard.js');

var _ProjectCard2 = _interopRequireDefault(_ProjectCard);

var _ErrMsg = require('../../../components/ErrMsg/ErrMsg.js');

var _ErrMsg2 = _interopRequireDefault(_ErrMsg);

var _coreDecorators = require('core-decorators');

var _user = require('../../../reducer/modules/user');

require('./ProjectList.scss');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _applyDecoratedDescriptor(target, property, decorators, descriptor, context) {
  var desc = {};
  Object['ke' + 'ys'](descriptor).forEach(function (key) {
    desc[key] = descriptor[key];
  });
  desc.enumerable = !!desc.enumerable;
  desc.configurable = !!desc.configurable;

  if ('value' in desc || desc.initializer) {
    desc.writable = true;
  }

  desc = decorators.slice().reverse().reduce(function (desc, decorator) {
    return decorator(target, property, desc) || desc;
  }, desc);

  if (context && desc.initializer !== void 0) {
    desc.value = desc.initializer ? desc.initializer.call(context) : void 0;
    desc.initializer = undefined;
  }

  if (desc.initializer === void 0) {
    Object['define' + 'Property'](target, property, desc);
    desc = null;
  }

  return desc;
}

var ProjectList = (_dec = (0, _reactRedux.connect)(function (state) {
  return {
    projectList: state.project.projectList,
    userInfo: state.project.userInfo,
    tableLoading: state.project.tableLoading,
    currGroup: state.group.currGroup,
    currPage: state.project.currPage
  };
}, {
  fetchProjectList: _project.fetchProjectList,
  addProject: _project.addProject,
  delProject: _project.delProject,
  changeUpdateModal: _project.changeUpdateModal,
  setBreadcrumb: _user.setBreadcrumb
}), _dec(_class = (_class2 = (_temp = _class3 = function (_Component) {
  (0, _inherits3.default)(ProjectList, _Component);

  function ProjectList(props) {
    (0, _classCallCheck3.default)(this, ProjectList);

    var _this = (0, _possibleConstructorReturn3.default)(this, _Component.call(this, props));

    _this.receiveRes = function () {
      _this.props.fetchProjectList(_this.props.currGroup._id, _this.props.currPage);
    };

    _this.state = {
      visible: false,
      protocol: 'http://',
      projectData: []
    };
    return _this;
  }

  // 取消修改
  ProjectList.prototype.handleCancel = function handleCancel() {
    this.props.form.resetFields();
    this.setState({
      visible: false
    });
  };

  // 修改线上域名的协议类型 (http/https)


  ProjectList.prototype.protocolChange = function protocolChange(value) {
    this.setState({
      protocol: value
    });
  };

  // 获取 ProjectCard 组件的关注事件回调，收到后更新数据

  ProjectList.prototype.componentWillReceiveProps = function componentWillReceiveProps(nextProps) {
    this.props.setBreadcrumb([{ name: '' + (nextProps.currGroup.group_name || '') }]);

    // 切换分组
    if (this.props.currGroup !== nextProps.currGroup && nextProps.currGroup._id) {
      this.props.fetchProjectList(nextProps.currGroup._id, this.props.currPage);
    }

    // 切换项目列表
    if (this.props.projectList !== nextProps.projectList) {
      // console.log(nextProps.projectList);
      var data = nextProps.projectList.map(function (item, index) {
        item.key = index;
        return item;
      });
      this.setState({
        projectData: data
      });
    }
  };

  ProjectList.prototype.render = function render() {
    var _this2 = this;

    var projectData = this.state.projectData;
    var noFollow = [];
    var followProject = [];
    for (var i in projectData) {
      if (projectData[i].follow) {
        followProject.push(projectData[i]);
      } else {
        noFollow.push(projectData[i]);
      }
    }
    followProject = followProject.sort(function (a, b) {
      return b.up_time - a.up_time;
    });
    noFollow = noFollow.sort(function (a, b) {
      return b.up_time - a.up_time;
    });
    projectData = [].concat(followProject, noFollow);

    var isShow = /(admin)|(owner)|(dev)/.test(this.props.currGroup.role);

    var Follow = function Follow() {
      return followProject.length ? _react2.default.createElement(
        _row2.default,
        null,
        _react2.default.createElement(
          'h3',
          { className: 'owner-type' },
          '\u6211\u7684\u5173\u6CE8'
        ),
        followProject.map(function (item, index) {
          return _react2.default.createElement(
            _col2.default,
            { xs: 8, lg: 6, xxl: 4, key: index },
            _react2.default.createElement(_ProjectCard2.default, { projectData: item, callbackResult: _this2.receiveRes })
          );
        })
      ) : null;
    };
    var NoFollow = function NoFollow() {
      return noFollow.length ? _react2.default.createElement(
        _row2.default,
        { style: { borderBottom: '1px solid #eee', marginBottom: '15px' } },
        _react2.default.createElement(
          'h3',
          { className: 'owner-type' },
          '\u6211\u7684\u9879\u76EE'
        ),
        noFollow.map(function (item, index) {
          return _react2.default.createElement(
            _col2.default,
            { xs: 8, lg: 6, xxl: 4, key: index },
            _react2.default.createElement(_ProjectCard2.default, { projectData: item, callbackResult: _this2.receiveRes, isShow: isShow })
          );
        })
      ) : null;
    };

    var OwnerSpace = function OwnerSpace() {
      return projectData.length ? _react2.default.createElement(
        'div',
        null,
        _react2.default.createElement(NoFollow, null),
        _react2.default.createElement(Follow, null)
      ) : _react2.default.createElement(_ErrMsg2.default, { type: 'noProject' });
    };

    return _react2.default.createElement(
      'div',
      { style: { paddingTop: '24px' }, className: 'm-panel card-panel card-panel-s project-list' },
      _react2.default.createElement(
        _row2.default,
        { className: 'project-list-header' },
        _react2.default.createElement(
          _col2.default,
          { span: 16, style: { textAlign: 'left' } },
          this.props.currGroup.group_name,
          ' \u5206\u7EC4\u5171 (',
          projectData.length,
          ') \u4E2A\u9879\u76EE'
        ),
        _react2.default.createElement(
          _col2.default,
          { span: 8 },
          isShow ? _react2.default.createElement(
            _reactRouterDom.Link,
            { to: '/add-project' },
            _react2.default.createElement(
              _button2.default,
              { type: 'primary' },
              '\u6DFB\u52A0\u9879\u76EE'
            )
          ) : _react2.default.createElement(
            _tooltip2.default,
            { title: '\u60A8\u6CA1\u6709\u6743\u9650,\u8BF7\u8054\u7CFB\u8BE5\u5206\u7EC4\u7EC4\u957F\u6216\u7BA1\u7406\u5458' },
            _react2.default.createElement(
              _button2.default,
              { type: 'primary', disabled: true },
              '\u6DFB\u52A0\u9879\u76EE'
            )
          )
        )
      ),
      _react2.default.createElement(
        _row2.default,
        null,
        this.props.currGroup.type === 'private' ? _react2.default.createElement(OwnerSpace, null) : projectData.length ? projectData.map(function (item, index) {
          return _react2.default.createElement(
            _col2.default,
            { xs: 8, lg: 6, xxl: 4, key: index },
            _react2.default.createElement(_ProjectCard2.default, {
              projectData: item,
              callbackResult: _this2.receiveRes,
              isShow: isShow
            })
          );
        }) : _react2.default.createElement(_ErrMsg2.default, { type: 'noProject' })
      )
    );
  };

  return ProjectList;
}(_react.PureComponent), _class3.propTypes = {
  form: _propTypes2.default.object,
  fetchProjectList: _propTypes2.default.func,
  addProject: _propTypes2.default.func,
  delProject: _propTypes2.default.func,
  changeUpdateModal: _propTypes2.default.func,
  projectList: _propTypes2.default.array,
  userInfo: _propTypes2.default.object,
  tableLoading: _propTypes2.default.bool,
  currGroup: _propTypes2.default.object,
  setBreadcrumb: _propTypes2.default.func,
  currPage: _propTypes2.default.number,
  studyTip: _propTypes2.default.number,
  study: _propTypes2.default.bool
}, _temp), (_applyDecoratedDescriptor(_class2.prototype, 'handleCancel', [_coreDecorators.autobind], (0, _getOwnPropertyDescriptor2.default)(_class2.prototype, 'handleCancel'), _class2.prototype), _applyDecoratedDescriptor(_class2.prototype, 'protocolChange', [_coreDecorators.autobind], (0, _getOwnPropertyDescriptor2.default)(_class2.prototype, 'protocolChange'), _class2.prototype)), _class2)) || _class);
exports.default = ProjectList;