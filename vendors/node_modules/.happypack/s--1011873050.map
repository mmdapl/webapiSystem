{"version":3,"sources":["common\\HandleImportData.js"],"names":["res","projectId","selectCatid","menuList","basePath","dataSync","messageError","messageSuccess","callback","token","port","handleAddCat","cats","catsObj","Array","isArray","i","cat","findCat","_","find","menu","name","id","_id","apipath","isNode","data","project_id","desc","axios","post","result","errcode","errmsg","showLoading","length","handleAddInterface","apis","len","count","successNum","existNum","index","item","catid","path","indexOf","substr","catname","handle","require","global","module","exports"],"mappings":"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","file":"HandleImportData.js","sourceRoot":"C:/Users/DUOYI/Desktop/api/test/vendors","sourcesContent":["const _ = require('underscore');\nconst axios = require('axios');\n\n\nconst isNode = typeof global == 'object' && global.global === global;\n\nasync function handle(\n  res,\n  projectId,\n  selectCatid,\n  menuList,\n  basePath,\n  dataSync,\n  messageError,\n  messageSuccess,\n  callback,\n  token,\n  port\n) {\n  const handleAddCat = async cats => {\n    let catsObj = {};\n    if (cats && Array.isArray(cats)) {\n      for (let i = 0; i < cats.length; i++) {\n        let cat = cats[i];\n        let findCat = _.find(menuList, menu => menu.name === cat.name);\n        catsObj[cat.name] = cat;\n        if (findCat) {\n          cat.id = findCat._id;\n        } else {\n          let apipath = '/api/interface/add_cat';\n          if (isNode) {\n            apipath = 'http://127.0.0.1:' + port + apipath;\n          }\n\n          let data = {\n            name: cat.name,\n            project_id: projectId,\n            desc: cat.desc,\n            token\n          };\n          let result = await axios.post(apipath, data);\n\n          if (result.data.errcode) {\n            messageError(result.data.errmsg);\n            callback({ showLoading: false });\n            return false;\n          }\n          cat.id = result.data.data._id;\n        }\n      }\n    }\n    return catsObj;\n  };\n\n  const handleAddInterface = async res => {\n    const cats = await handleAddCat(res.cats);\n    if (cats === false) {\n      return;\n    }\n    res = res.apis;\n    let len = res.length;\n    let count = 0;\n    let successNum = len;\n    let existNum = 0;\n    if (len === 0) {\n      messageError(`解析数据为空`);\n      callback({ showLoading: false });\n      return;\n    }\n    for (let index = 0; index < res.length; index++) {\n      let item = res[index];\n      let data = Object.assign(item, {\n        project_id: projectId,\n        catid: selectCatid\n      });\n      if (basePath) {\n        data.path =\n          data.path.indexOf(basePath) === 0 ? data.path.substr(basePath.length) : data.path;\n      }\n      if (\n        data.catname &&\n        cats[data.catname] &&\n        typeof cats[data.catname] === 'object' &&\n        cats[data.catname].id\n      ) {\n        data.catid = cats[data.catname].id;\n      }\n      data.token = token;\n\n      if (dataSync !== 'normal') {\n        // 开启同步功能\n        count++;\n        let apipath = '/api/interface/save';\n        if (isNode) {\n          apipath = 'http://127.0.0.1:' + port + apipath;\n        }\n        data.dataSync = dataSync;\n        let result = await axios.post(apipath, data);\n        if (result.data.errcode) {\n          successNum--;\n          callback({ showLoading: false });\n          messageError(result.data.errmsg);\n        } else {\n          existNum = existNum + result.data.data.length;\n        }\n      } else {\n        // 未开启同步功能\n        count++;\n        let apipath = '/api/interface/add';\n        if (isNode) {\n          apipath = 'http://127.0.0.1:' + port + apipath;\n        }\n        let result = await axios.post(apipath, data);\n        if (result.data.errcode) {\n          successNum--;\n          if (result.data.errcode == 40022) {\n            existNum++;\n          }\n          if (result.data.errcode == 40033) {\n            callback({ showLoading: false });\n            messageError('没有权限');\n            break;\n          }\n        }\n      }\n      if (count === len) {\n        callback({ showLoading: false });\n        messageSuccess(`成功导入接口 ${successNum} 个, 已存在的接口 ${existNum} 个`);\n      }\n    }\n  };\n\n  return await handleAddInterface(res);\n}\n\nmodule.exports = handle;\n"]}