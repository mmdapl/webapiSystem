{"version":3,"sources":["exts\\yapi-plugin-wiki\\wikiPage\\index.js"],"names":["WikiPage","projectMsg","state","project","currProject","props","endWebSocket","status","sendEnd","WebSocket","send","handleWebsocketAccidentClose","e","handleConflict","domain","location","hostname","port","s","wsProtocol","protocol","match","params","id","onopen","onmessage","result","JSON","parse","data","errno","setState","desc","username","uid","editorTime","up_time","isEditor","editUid","editName","onerror","console","warn","onEditor","sendEditor","fn","callback","readyState","error","handleData","axios","get","errcode","markdown","errmsg","onUpload","currProjectId","option","project_id","email_notice","notice","post","onCancel","onEmailNotice","target","checked","isUpload","switch_notice","curdata","componentDidMount","componentWillUnmount","close","render","editorEable","role","isConflict","Component","propTypes","PropTypes","object"],"mappings":"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","file":"index.js","sourceRoot":"C:/Users/DUOYI/Desktop/api/test/vendors","sourcesContent":["import React, { Component } from 'react';\nimport { message } from 'antd';\nimport { connect } from 'react-redux';\nimport axios from 'axios';\nimport PropTypes from 'prop-types';\nimport './index.scss';\nimport { timeago } from '../../../common/utils';\nimport { Link } from 'react-router-dom';\nimport WikiView from './View.js';\nimport WikiEditor from './Editor.js';\n\n@connect(\n  state => {\n    return {\n      projectMsg: state.project.currProject\n    };\n  },\n  {}\n)\nclass WikiPage extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      isEditor: false,\n      isUpload: true,\n      desc: '',\n      markdown: '',\n      notice: props.projectMsg.switch_notice,\n      status: 'INIT',\n      editUid: '',\n      editName: '',\n      curdata: null\n    };\n  }\n\n  static propTypes = {\n    match: PropTypes.object,\n    projectMsg: PropTypes.object\n  };\n\n  async componentDidMount() {\n    const currProjectId = this.props.match.params.id;\n    await this.handleData({ project_id: currProjectId });\n    this.handleConflict();\n  }\n\n  componentWillUnmount() {\n    // willUnmount\n    try {\n      if (this.state.status === 'CLOSE') {\n        this.WebSocket.send('end');\n        this.WebSocket.close();\n      }\n    } catch (e) {\n      return null;\n    }\n  }\n  // 结束编辑websocket\n  endWebSocket = () => {\n    try {\n      if (this.state.status === 'CLOSE') {\n        const sendEnd = () => {\n          this.WebSocket.send('end');\n        };\n        this.handleWebsocketAccidentClose(sendEnd);\n      }\n    } catch (e) {\n      return null;\n    }\n  };\n\n  // 处理多人编辑冲突问题\n  handleConflict = () => {\n    // console.log(location)\n    let domain = location.hostname + (location.port !== '' ? ':' + location.port : '');\n    let s;\n    //因后端 node 仅支持 ws， 暂不支持 wss\n    let wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';\n    s = new WebSocket(\n      wsProtocol +\n        '://' +\n        domain +\n        '/api/ws_plugin/wiki_desc/solve_conflict?id=' +\n        this.props.match.params.id\n    );\n    s.onopen = () => {\n      this.WebSocket = s;\n      s.send('start');\n    };\n\n    s.onmessage = e => {\n      let result = JSON.parse(e.data);\n      if (result.errno === 0) {\n        // 更新\n        if (result.data) {\n          this.setState({\n            // curdata: result.data,\n            desc: result.data.desc,\n            username: result.data.username,\n            uid: result.data.uid,\n            editorTime: timeago(result.data.up_time)\n          });\n        }\n        // 新建\n        this.setState({\n          isEditor: !this.state.isEditor,\n          status: 'CLOSE'\n        });\n      } else {\n        this.setState({\n          editUid: result.data.uid,\n          editName: result.data.username,\n          status: 'EDITOR'\n        });\n      }\n    };\n\n    s.onerror = () => {\n      this.setState({\n        status: 'CLOSE'\n      });\n      console.warn('websocket 连接失败，将导致多人编辑同一个接口冲突。');\n    };\n  };\n\n  // 点击编辑按钮 发送 websocket 获取数据\n  onEditor = () => {\n    // this.WebSocket.send('editor');\n    const sendEditor = () => {\n      this.WebSocket.send('editor');\n    };\n    this.handleWebsocketAccidentClose(sendEditor, status => {\n      // 如果websocket 启动不成功用户依旧可以对wiki 进行编辑\n      if (!status) {\n        this.setState({\n          isEditor: !this.state.isEditor\n        });\n      }\n    });\n  };\n\n  // 处理websocket  意外断开问题\n  handleWebsocketAccidentClose = (fn, callback) => {\n    // websocket 是否启动\n    if (this.WebSocket) {\n      // websocket 断开\n      if (this.WebSocket.readyState !== 1) {\n        message.error('websocket 链接失败，请重新刷新页面');\n      } else {\n        fn();\n      }\n      callback(true);\n    } else {\n      callback(false);\n    }\n  };\n\n  //  获取数据\n  handleData = async params => {\n    let result = await axios.get('/api/plugin/wiki_desc/get', { params });\n    if (result.data.errcode === 0) {\n      const data = result.data.data;\n      if (data) {\n        this.setState({\n          desc: data.desc,\n          markdown: data.markdown,\n          username: data.username,\n          uid: data.uid,\n          editorTime: timeago(data.up_time)\n        });\n      }\n    } else {\n      message.error(`请求数据失败： ${result.data.errmsg}`);\n    }\n  };\n\n  // 数据上传\n  onUpload = async (desc, markdown) => {\n    const currProjectId = this.props.match.params.id;\n    let option = {\n      project_id: currProjectId,\n      desc,\n      markdown,\n      email_notice: this.state.notice\n    };\n    let result = await axios.post('/api/plugin/wiki_desc/up', option);\n    if (result.data.errcode === 0) {\n      await this.handleData({ project_id: currProjectId });\n      this.setState({ isEditor: false });\n    } else {\n      message.error(`更新失败： ${result.data.errmsg}`);\n    }\n    this.endWebSocket();\n    // this.WebSocket.send('end');\n  };\n  // 取消编辑\n  onCancel = () => {\n    this.setState({ isEditor: false });\n    this.endWebSocket();\n  };\n\n  // 邮件通知\n  onEmailNotice = e => {\n    this.setState({\n      notice: e.target.checked\n    });\n  };\n\n  render() {\n    const { isEditor, username, editorTime, notice, uid, status, editUid, editName } = this.state;\n    const editorEable =\n      this.props.projectMsg.role === 'admin' ||\n      this.props.projectMsg.role === 'owner' ||\n      this.props.projectMsg.role === 'dev';\n    const isConflict = status === 'EDITOR';\n\n    return (\n      <div className=\"g-row\">\n        <div className=\"m-panel wiki-content\">\n          <div className=\"wiki-content\">\n            {isConflict && (\n              <div className=\"wiki-conflict\">\n                <Link to={`/user/profile/${editUid || uid}`}>\n                  <b>{editName || username}</b>\n                </Link>\n                <span>正在编辑该wiki，请稍后再试...</span>\n              </div>\n            )}\n          </div>\n          {!isEditor ? (\n            <WikiView\n              editorEable={editorEable}\n              onEditor={this.onEditor}\n              uid={uid}\n              username={username}\n              editorTime={editorTime}\n              desc={this.state.desc}\n            />\n          ) : (\n            <WikiEditor\n              isConflict={isConflict}\n              onUpload={this.onUpload}\n              onCancel={this.onCancel}\n              notice={notice}\n              onEmailNotice={this.onEmailNotice}\n              desc={this.state.desc}\n            />\n          )}\n        </div>\n      </div>\n    );\n  }\n}\n\nexport default WikiPage;\n"]}