'use strict';

exports.__esModule = true;

var _table = require('antd/lib/table');

var _table2 = _interopRequireDefault(_table);

var _popconfirm = require('antd/lib/popconfirm');

var _popconfirm2 = _interopRequireDefault(_popconfirm);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _message2 = require('antd/lib/message');

var _message3 = _interopRequireDefault(_message2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _input = require('antd/lib/input');

var _input2 = _interopRequireDefault(_input);

var _dec, _class, _class2, _temp;
//import PropTypes from 'prop-types'


var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _common = require('../../common.js');

var _reactRouterDom = require('react-router-dom');

var _user = require('../../reducer/modules/user');

var _reactRedux = require('react-redux');

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _axios = require('axios');

var _axios2 = _interopRequireDefault(_axios);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Search = _input2.default.Search;
var limit = 20;
var List = (_dec = (0, _reactRedux.connect)(function (state) {
  return {
    curUserRole: state.user.role
  };
}, {
  setBreadcrumb: _user.setBreadcrumb
}), _dec(_class = (_temp = _class2 = function (_Component) {
  (0, _inherits3.default)(List, _Component);

  function List(props) {
    (0, _classCallCheck3.default)(this, List);

    var _this = (0, _possibleConstructorReturn3.default)(this, _Component.call(this, props));

    _this.changePage = function (current) {
      _this.setState({
        current: current
      }, _this.getUserList);
    };

    _this.confirm = function (uid) {
      _axios2.default.post('/api/user/del', {
        id: uid
      }).then(function (res) {
        if (res.data.errcode === 0) {
          _message3.default.success('已删除此用户');
          var userlist = _this.state.data;
          userlist = userlist.filter(function (item) {
            return item._id != uid;
          });
          _this.setState({
            data: userlist
          });
        } else {
          _message3.default.error(res.data.errmsg);
        }
      }, function (err) {
        _message3.default.error(err.message);
      });
    };

    _this.handleSearch = function (value) {
      var params = { q: value };
      if (params.q !== '') {
        _axios2.default.get('/api/user/search', { params: params }).then(function (data) {
          var userList = [];

          data = data.data.data;
          if (data) {
            data.forEach(function (v) {
              return userList.push((0, _extends3.default)({}, v, {
                _id: v.uid
              }));
            });
          }

          _this.setState({
            data: userList,
            isSearch: true
          });
        });
      } else {
        _this.setState({
          data: _this.state.backups,
          isSearch: false
        });
      }
    };

    _this.state = {
      data: [],
      total: null,
      current: 1,
      backups: [],
      isSearch: false
    };
    return _this;
  }

  List.prototype.getUserList = function getUserList() {
    var _this2 = this;

    _axios2.default.get('/api/user/list?page=' + this.state.current + '&limit=' + limit).then(function (res) {
      var result = res.data;

      if (result.errcode === 0) {
        var list = result.data.list;
        var total = result.data.count;
        list.map(function (item, index) {
          item.key = index;
          item.up_time = (0, _common.formatTime)(item.up_time);
        });
        _this2.setState({
          data: list,
          total: total,
          backups: list
        });
      }
    });
  };

  List.prototype.componentDidMount = function componentDidMount() {
    this.getUserList();
  };

  List.prototype.componentWillMount = function () {
    var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {
      return _regenerator2.default.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              this.props.setBreadcrumb([{ name: '用户管理' }]);

            case 1:
            case 'end':
              return _context.stop();
          }
        }
      }, _callee, this);
    }));

    function componentWillMount() {
      return _ref.apply(this, arguments);
    }

    return componentWillMount;
  }();

  List.prototype.render = function render() {
    var _this3 = this;

    var role = this.props.curUserRole;
    var data = [];
    if (role === 'admin') {
      data = this.state.data;
    }
    var columns = [{
      title: '用户名',
      dataIndex: 'username',
      key: 'username',
      width: 180,
      render: function render(username, item) {
        return _react2.default.createElement(
          _reactRouterDom.Link,
          { to: '/user/profile/' + item._id },
          item.username
        );
      }
    }, {
      title: 'Email',
      dataIndex: 'email',
      key: 'email'
    }, {
      title: '用户角色',
      dataIndex: 'role',
      key: 'role',
      width: 150
    }, {
      title: '更新日期',
      dataIndex: 'up_time',
      key: 'up_time',
      width: 160
    }, {
      title: '功能',
      key: 'action',
      width: '90px',
      render: function render(item) {
        return _react2.default.createElement(
          'span',
          null,
          _react2.default.createElement(
            _popconfirm2.default,
            {
              title: '\u786E\u8BA4\u5220\u9664\u6B64\u7528\u6237?',
              onConfirm: function onConfirm() {
                _this3.confirm(item._id);
              },
              okText: '\u786E\u5B9A',
              cancelText: '\u53D6\u6D88'
            },
            _react2.default.createElement(
              'a',
              { style: { display: 'block', textAlign: 'center' }, href: '#' },
              '\u5220\u9664'
            )
          )
        );
      }
    }];

    columns = columns.filter(function (item) {
      if (item.key === 'action' && role !== 'admin') {
        return false;
      }
      return true;
    });

    var pageConfig = {
      total: this.state.total,
      pageSize: limit,
      current: this.state.current,
      onChange: this.changePage
    };

    var defaultPageConfig = {
      total: this.state.data.length,
      pageSize: limit,
      current: 1
    };

    return _react2.default.createElement(
      'section',
      { className: 'user-table' },
      _react2.default.createElement(
        'div',
        { className: 'user-search-wrapper' },
        _react2.default.createElement(
          'h2',
          { style: { marginBottom: '10px' } },
          '\u7528\u6237\u603B\u6570\uFF1A',
          this.state.total,
          '\u4F4D'
        ),
        _react2.default.createElement(Search, {
          onChange: function onChange(e) {
            return _this3.handleSearch(e.target.value);
          },
          onSearch: this.handleSearch,
          placeholder: '\u8BF7\u8F93\u5165\u7528\u6237\u540D'
        })
      ),
      _react2.default.createElement(_table2.default, {
        bordered: true,
        rowKey: function rowKey(record) {
          return record._id;
        },
        columns: columns,
        pagination: this.state.isSearch ? defaultPageConfig : pageConfig,
        dataSource: data
      })
    );
  };

  return List;
}(_react.PureComponent), _class2.propTypes = {
  setBreadcrumb: _propTypes2.default.func,
  curUserRole: _propTypes2.default.string
}, _temp)) || _class);
exports.default = List;