'use strict';

exports.__esModule = true;
exports.default = undefined;

var _button = require('antd/lib/button');

var _button2 = _interopRequireDefault(_button);

var _input = require('antd/lib/input');

var _input2 = _interopRequireDefault(_input);

var _tooltip = require('antd/lib/tooltip');

var _tooltip2 = _interopRequireDefault(_tooltip);

var _icon = require('antd/lib/icon');

var _icon2 = _interopRequireDefault(_icon);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _switch = require('antd/lib/switch');

var _switch2 = _interopRequireDefault(_switch);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _message2 = require('antd/lib/message');

var _message3 = _interopRequireDefault(_message2);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _select = require('antd/lib/select');

var _select2 = _interopRequireDefault(_select);

var _form = require('antd/lib/form');

var _form2 = _interopRequireDefault(_form);

var _dec, _dec2, _class, _class2, _temp;

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactRedux = require('react-redux');

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _common = require('../../../client/common.js');

var _project = require('../../../client/reducer/modules/project');

var _axios = require('axios');

var _axios2 = _interopRequireDefault(_axios);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var FormItem = _form2.default.Item;
var Option = _select2.default.Option;


// layout
var formItemLayout = {
  labelCol: {
    lg: { span: 5 },
    xs: { span: 24 },
    sm: { span: 10 }
  },
  wrapperCol: {
    lg: { span: 16 },
    xs: { span: 24 },
    sm: { span: 12 }
  },
  className: 'form-item'
};
var tailFormItemLayout = {
  wrapperCol: {
    sm: {
      span: 16,
      offset: 11
    }
  }
};

var ProjectInterfaceSync = (_dec = (0, _reactRedux.connect)(function (state) {
  return {
    projectMsg: state.project.currProject
  };
}, {
  handleSwaggerUrlData: _project.handleSwaggerUrlData
}), _dec2 = _form2.default.create(), _dec(_class = _dec2(_class = (_temp = _class2 = function (_Component) {
  (0, _inherits3.default)(ProjectInterfaceSync, _Component);

  function ProjectInterfaceSync(props) {
    var _this2 = this;

    (0, _classCallCheck3.default)(this, ProjectInterfaceSync);

    var _this = (0, _possibleConstructorReturn3.default)(this, _Component.call(this, props));

    _this.handleSubmit = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {
      var _this$props, form, projectId, params;

      return _regenerator2.default.wrap(function _callee2$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              _this$props = _this.props, form = _this$props.form, projectId = _this$props.projectId;
              params = {
                project_id: projectId,
                is_sync_open: _this.state.sync_data.is_sync_open,
                uid: _this.props.projectMsg.uid
              };

              if (_this.state.sync_data._id) {
                params.id = _this.state.sync_data._id;
              }
              form.validateFields(function () {
                var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(err, values) {
                  var assignValue;
                  return _regenerator2.default.wrap(function _callee$(_context) {
                    while (1) {
                      switch (_context.prev = _context.next) {
                        case 0:
                          if (err) {
                            _context.next = 4;
                            break;
                          }

                          assignValue = (0, _assign2.default)(params, values);
                          _context.next = 4;
                          return _axios2.default.post('/api/plugin/autoSync/save', assignValue).then(function (res) {
                            if (res.data.errcode === 0) {
                              _message3.default.success('保存成功');
                            } else {
                              _message3.default.error(res.data.errmsg);
                            }
                          });

                        case 4:
                        case 'end':
                          return _context.stop();
                      }
                    }
                  }, _callee, _this2);
                }));

                return function (_x, _x2) {
                  return _ref2.apply(this, arguments);
                };
              }());

            case 4:
            case 'end':
              return _context2.stop();
          }
        }
      }, _callee2, _this2);
    }));

    _this.validSwaggerUrl = function () {
      var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(rule, value, callback) {
        return _regenerator2.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                _context3.prev = 0;
                _context3.next = 3;
                return _this.props.handleSwaggerUrlData(value);

              case 3:
                _context3.next = 8;
                break;

              case 5:
                _context3.prev = 5;
                _context3.t0 = _context3['catch'](0);

                callback('swagger地址不正确');

              case 8:
                callback();

              case 9:
              case 'end':
                return _context3.stop();
            }
          }
        }, _callee3, _this2, [[0, 5]]);
      }));

      return function (_x3, _x4, _x5) {
        return _ref3.apply(this, arguments);
      };
    }();

    _this.onChange = function (v) {
      var sync_data = _this.state.sync_data;
      sync_data.is_sync_open = v;
      _this.setState({
        sync_data: sync_data
      });
    };

    _this.state = {
      sync_data: { is_sync_open: false }
    };
    return _this;
  }

  ProjectInterfaceSync.prototype.componentWillMount = function componentWillMount() {
    //查询同步任务
    this.setState({
      sync_data: {}
    });
    //默认每份钟同步一次,取一个随机数
    this.setState({
      random_corn: Math.round(Math.random() * 60) + ' * * * * *'
    });
    this.getSyncData();
  };

  ProjectInterfaceSync.prototype.getSyncData = function () {
    var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee4() {
      var projectId, result;
      return _regenerator2.default.wrap(function _callee4$(_context4) {
        while (1) {
          switch (_context4.prev = _context4.next) {
            case 0:
              projectId = this.props.projectMsg._id;
              _context4.next = 3;
              return _axios2.default.get('/api/plugin/autoSync/get?project_id=' + projectId);

            case 3:
              result = _context4.sent;

              if (result.data.errcode === 0) {
                if (result.data.data) {
                  this.setState({
                    sync_data: result.data.data
                  });
                }
              }

            case 5:
            case 'end':
              return _context4.stop();
          }
        }
      }, _callee4, this);
    }));

    function getSyncData() {
      return _ref4.apply(this, arguments);
    }

    return getSyncData;
  }();

  // 是否开启


  ProjectInterfaceSync.prototype.render = function render() {
    var getFieldDecorator = this.props.form.getFieldDecorator;

    return _react2.default.createElement(
      'div',
      { className: 'm-panel' },
      _react2.default.createElement(
        _form2.default,
        null,
        _react2.default.createElement(
          FormItem,
          (0, _extends3.default)({
            label: '\u662F\u5426\u5F00\u542F\u81EA\u52A8\u540C\u6B65'
          }, formItemLayout),
          _react2.default.createElement(_switch2.default, {
            checked: this.state.sync_data.is_sync_open,
            onChange: this.onChange,
            checkedChildren: '\u5F00',
            unCheckedChildren: '\u5173'
          }),
          this.state.sync_data.last_sync_time != null ? _react2.default.createElement(
            'div',
            null,
            '\u4E0A\u6B21\u66F4\u65B0\u65F6\u95F4:',
            _react2.default.createElement(
              'span',
              { className: 'logtime' },
              (0, _common.formatTime)(this.state.sync_data.last_sync_time)
            )
          ) : null
        ),
        _react2.default.createElement(
          'div',
          null,
          _react2.default.createElement(
            FormItem,
            (0, _extends3.default)({}, formItemLayout, { label: _react2.default.createElement(
                'span',
                { className: 'label' },
                '\u6570\u636E\u540C\u6B65\xA0',
                _react2.default.createElement(
                  _tooltip2.default,
                  {
                    title: _react2.default.createElement(
                      'div',
                      null,
                      _react2.default.createElement(
                        'h3',
                        { style: { color: 'white' } },
                        '\u666E\u901A\u6A21\u5F0F'
                      ),
                      _react2.default.createElement(
                        'p',
                        null,
                        '\u4E0D\u5BFC\u5165\u5DF2\u5B58\u5728\u7684\u63A5\u53E3'
                      ),
                      _react2.default.createElement('br', null),
                      _react2.default.createElement(
                        'h3',
                        { style: { color: 'white' } },
                        '\u667A\u80FD\u5408\u5E76'
                      ),
                      _react2.default.createElement(
                        'p',
                        null,
                        '\u5DF2\u5B58\u5728\u7684\u63A5\u53E3\uFF0C\u5C06\u5408\u5E76\u8FD4\u56DE\u6570\u636E\u7684 response\uFF0C\u9002\u7528\u4E8E\u5BFC\u5165\u4E86 swagger \u6570\u636E\uFF0C\u4FDD\u7559\u5BF9\u6570\u636E\u7ED3\u6784\u7684\u6539\u52A8'
                      ),
                      _react2.default.createElement('br', null),
                      _react2.default.createElement(
                        'h3',
                        { style: { color: 'white' } },
                        '\u5B8C\u5168\u8986\u76D6'
                      ),
                      _react2.default.createElement(
                        'p',
                        null,
                        '\u4E0D\u4FDD\u7559\u65E7\u6570\u636E\uFF0C\u5B8C\u5168\u4F7F\u7528\u65B0\u6570\u636E\uFF0C\u9002\u7528\u4E8E\u63A5\u53E3\u5B9A\u4E49\u5B8C\u5168\u4EA4\u7ED9\u540E\u7AEF\u5B9A\u4E49'
                      )
                    )
                  },
                  _react2.default.createElement(_icon2.default, { type: 'question-circle-o' })
                ),
                ' '
              ) }),
            getFieldDecorator('sync_mode', {
              initialValue: this.state.sync_data.sync_mode,
              rules: [{
                required: true,
                message: '请选择同步方式!'
              }]
            })(_react2.default.createElement(
              _select2.default,
              null,
              _react2.default.createElement(
                Option,
                { value: 'normal' },
                '\u666E\u901A\u6A21\u5F0F'
              ),
              _react2.default.createElement(
                Option,
                { value: 'good' },
                '\u667A\u80FD\u5408\u5E76'
              ),
              _react2.default.createElement(
                Option,
                { value: 'merge' },
                '\u5B8C\u5168\u8986\u76D6'
              )
            ))
          ),
          _react2.default.createElement(
            FormItem,
            (0, _extends3.default)({}, formItemLayout, { label: '\u9879\u76EE\u7684swagger json\u5730\u5740' }),
            getFieldDecorator('sync_json_url', {
              rules: [{
                required: true,
                message: '输入swagger地址'
              }, {
                validator: this.validSwaggerUrl
              }],
              validateTrigger: 'onBlur',
              initialValue: this.state.sync_data.sync_json_url
            })(_react2.default.createElement(_input2.default, null))
          ),
          _react2.default.createElement(
            FormItem,
            (0, _extends3.default)({}, formItemLayout, { label: _react2.default.createElement(
                'span',
                null,
                '\u7C7Bcron\u98CE\u683C\u8868\u8FBE\u5F0F(\u9ED8\u8BA4\u6BCF\u5206\u949F\u66F4\u65B0\u4E00\u6B21)\xA0',
                _react2.default.createElement(
                  'a',
                  { href: 'https://blog.csdn.net/shouldnotappearcalm/article/details/89469047' },
                  '\u53C2\u8003'
                )
              ) }),
            getFieldDecorator('sync_cron', {
              rules: [{
                required: true,
                message: '输入node-schedule的类cron表达式!'
              }],
              initialValue: this.state.sync_data.sync_cron ? this.state.sync_data.sync_cron : this.state.random_corn
            })(_react2.default.createElement(_input2.default, null))
          )
        ),
        _react2.default.createElement(
          FormItem,
          tailFormItemLayout,
          _react2.default.createElement(
            _button2.default,
            { type: 'primary', htmlType: 'submit', icon: 'save', size: 'large', onClick: this.handleSubmit },
            '\u4FDD\u5B58'
          )
        )
      )
    );
  };

  return ProjectInterfaceSync;
}(_react.Component), _class2.propTypes = {
  form: _propTypes2.default.object,
  match: _propTypes2.default.object,
  projectId: _propTypes2.default.number,
  projectMsg: _propTypes2.default.object,
  handleSwaggerUrlData: _propTypes2.default.func
}, _temp)) || _class) || _class);
exports.default = ProjectInterfaceSync;