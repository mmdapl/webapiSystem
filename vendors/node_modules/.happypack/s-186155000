'use strict';

exports.__esModule = true;
exports.default = undefined;

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _alert = require('antd/lib/alert');

var _alert2 = _interopRequireDefault(_alert);

var _dec, _class, _class2, _temp;

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactDom = require('react-dom');

var _reactDom2 = _interopRequireDefault(_reactDom);

var _reactRedux = require('react-redux');

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _reactRouterDom = require('react-router-dom');

var _index = require('./containers/index');

var _User = require('./containers/User/User.js');

var _User2 = _interopRequireDefault(_User);

var _Header = require('./components/Header/Header');

var _Header2 = _interopRequireDefault(_Header);

var _Footer = require('./components/Footer/Footer');

var _Footer2 = _interopRequireDefault(_Footer);

var _Loading = require('./components/Loading/Loading');

var _Loading2 = _interopRequireDefault(_Loading);

var _MyPopConfirm = require('./components/MyPopConfirm/MyPopConfirm');

var _MyPopConfirm2 = _interopRequireDefault(_MyPopConfirm);

var _user = require('./reducer/modules/user');

var _AuthenticatedComponent = require('./components/AuthenticatedComponent');

var _Notify = require('./components/Notify/Notify');

var _Notify2 = _interopRequireDefault(_Notify);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var plugin = require('./plugin.js');

var LOADING_STATUS = 0;

var alertContent = function alertContent() {
  var ua = window.navigator.userAgent,
      isChrome = ua.indexOf('Chrome') && window.chrome;
  if (!isChrome) {
    return _react2.default.createElement(_alert2.default, {
      style: { zIndex: 99 },
      message: 'YApi 的接口测试等功能仅支持 Chrome 浏览器，请使用 Chrome 浏览器获得完整功能。',
      banner: true,
      closable: true
    });
  }
};

var AppRoute = {
  home: {
    path: '/',
    component: _index.Home
  },
  group: {
    path: '/group',
    component: _index.Group
  },
  project: {
    path: '/project/:id',
    component: _index.Project
  },
  user: {
    path: '/user',
    component: _User2.default
  },
  follow: {
    path: '/follow',
    component: _index.Follows
  },
  addProject: {
    path: '/add-project',
    component: _index.AddProject
  },
  login: {
    path: '/login',
    component: _index.Login
  }
};
// 增加路由钩子
plugin.emitHook('app_route', AppRoute);

var App = (_dec = (0, _reactRedux.connect)(function (state) {
  return {
    loginState: state.user.loginState,
    curUserRole: state.user.role
  };
}, {
  checkLoginState: _user.checkLoginState
}), _dec(_class = (_temp = _class2 = function (_Component) {
  (0, _inherits3.default)(App, _Component);

  function App(props) {
    (0, _classCallCheck3.default)(this, App);

    var _this = (0, _possibleConstructorReturn3.default)(this, _Component.call(this, props));

    _this.showConfirm = function (msg, callback) {
      // 自定义 window.confirm
      // http://reacttraining.cn/web/api/BrowserRouter/getUserConfirmation-func
      var container = document.createElement('div');
      document.body.appendChild(container);
      _reactDom2.default.render(_react2.default.createElement(_MyPopConfirm2.default, { msg: msg, callback: callback }), container);
    };

    _this.route = function (status) {
      var r = void 0;
      if (status === LOADING_STATUS) {
        return _react2.default.createElement(_Loading2.default, { visible: true });
      } else {
        r = _react2.default.createElement(
          _reactRouterDom.BrowserRouter,
          { getUserConfirmation: _this.showConfirm },
          _react2.default.createElement(
            'div',
            { className: 'g-main' },
            _react2.default.createElement(
              'div',
              { className: 'router-main' },
              _this.props.curUserRole === 'admin' && _react2.default.createElement(_Notify2.default, null),
              alertContent(),
              _this.props.loginState !== 1 ? _react2.default.createElement(_Header2.default, null) : null,
              _react2.default.createElement(
                'div',
                { className: 'router-container' },
                (0, _keys2.default)(AppRoute).map(function (key) {
                  var item = AppRoute[key];
                  return key === 'login' ? _react2.default.createElement(_reactRouterDom.Route, { key: key, path: item.path, component: item.component }) : key === 'home' ? _react2.default.createElement(_reactRouterDom.Route, { key: key, exact: true, path: item.path, component: item.component }) : _react2.default.createElement(_reactRouterDom.Route, {
                    key: key,
                    path: item.path,
                    component: (0, _AuthenticatedComponent.requireAuthentication)(item.component)
                  });
                })
              )
            ),
            _react2.default.createElement(_Footer2.default, null)
          )
        );
      }
      return r;
    };

    _this.state = {
      login: LOADING_STATUS
    };
    return _this;
  }

  App.prototype.componentDidMount = function componentDidMount() {
    this.props.checkLoginState();
  };

  App.prototype.render = function render() {
    return this.route(this.props.loginState);
  };

  return App;
}(_react.PureComponent), _class2.propTypes = {
  checkLoginState: _propTypes2.default.func,
  loginState: _propTypes2.default.number,
  curUserRole: _propTypes2.default.string
}, _temp)) || _class);
exports.default = App;