'use strict';

exports.__esModule = true;
exports.default = undefined;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _message2 = require('antd/lib/message');

var _message3 = _interopRequireDefault(_message2);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _typeof2 = require('babel-runtime/helpers/typeof');

var _typeof3 = _interopRequireDefault(_typeof2);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _dec, _class, _class2, _temp;

// import {
// } from '../../../reducer/modules/group.js'

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _reactRedux = require('react-redux');

var _reactRouter = require('react-router');

var _axios = require('axios');

var _axios2 = _interopRequireDefault(_axios);

var _components = require('../../../../../components');

var _AddColModal = require('./AddColModal');

var _AddColModal2 = _interopRequireDefault(_AddColModal);

require('./Run.scss');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Run = (_dec = (0, _reactRedux.connect)(function (state) {
  return {
    currInterface: state.inter.curdata,
    currProject: state.project.currProject,
    curUid: state.user.uid
  };
}), _dec(_class = (0, _reactRouter.withRouter)(_class = (_temp = _class2 = function (_Component) {
  (0, _inherits3.default)(Run, _Component);

  function Run(props) {
    var _this2 = this;

    (0, _classCallCheck3.default)(this, Run);

    var _this = (0, _possibleConstructorReturn3.default)(this, _Component.call(this, props));

    _this.state = {};

    _this.savePostmanRef = function (postman) {
      _this.postman = postman;
    };

    _this.saveCase = function () {
      var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(colId, caseName) {
        var project_id, interface_id, _this$postman$state, case_env, req_params, req_query, req_headers, req_body_type, req_body_form, req_body_other, params, res;

        return _regenerator2.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                project_id = _this.props.match.params.id;
                interface_id = _this.props.currInterface._id;
                _this$postman$state = _this.postman.state, case_env = _this$postman$state.case_env, req_params = _this$postman$state.req_params, req_query = _this$postman$state.req_query, req_headers = _this$postman$state.req_headers, req_body_type = _this$postman$state.req_body_type, req_body_form = _this$postman$state.req_body_form, req_body_other = _this$postman$state.req_body_other;
                params = {
                  interface_id: interface_id,
                  casename: caseName,
                  col_id: colId,
                  project_id: project_id,
                  case_env: case_env,
                  req_params: req_params,
                  req_query: req_query,
                  req_headers: req_headers,
                  req_body_type: req_body_type,
                  req_body_form: req_body_form,
                  req_body_other: req_body_other
                };


                if (params.test_res_body && (0, _typeof3.default)(params.test_res_body) === 'object') {
                  params.test_res_body = (0, _stringify2.default)(params.test_res_body, null, '   ');
                }

                _context.next = 7;
                return _axios2.default.post('/api/col/add_case', params);

              case 7:
                res = _context.sent;

                if (res.data.errcode) {
                  _message3.default.error(res.data.errmsg);
                } else {
                  _message3.default.success('添加成功');
                  _this.setState({ saveCaseModalVisible: false });
                }

              case 9:
              case 'end':
                return _context.stop();
            }
          }
        }, _callee, _this2);
      }));

      return function (_x, _x2) {
        return _ref.apply(this, arguments);
      };
    }();

    return _this;
  }

  Run.prototype.componentWillMount = function componentWillMount() {};

  Run.prototype.componentWillReceiveProps = function componentWillReceiveProps() {};

  Run.prototype.render = function render() {
    var _this3 = this;

    var _props = this.props,
        currInterface = _props.currInterface,
        currProject = _props.currProject;

    var data = (0, _assign2.default)({}, currInterface, {
      env: currProject.env,
      pre_script: currProject.pre_script,
      after_script: currProject.after_script
    });
    data.path = currProject.basepath + currInterface.path;
    return _react2.default.createElement(
      'div',
      null,
      _react2.default.createElement(_components.Postman, {
        data: data,
        id: currProject._id,
        type: 'inter',
        saveTip: '\u4FDD\u5B58\u5230\u96C6\u5408',
        save: function save() {
          return _this3.setState({ saveCaseModalVisible: true });
        },
        ref: this.savePostmanRef,
        interfaceId: currInterface._id,
        projectId: currInterface.project_id,
        curUid: this.props.curUid
      }),
      _react2.default.createElement(_AddColModal2.default, {
        visible: this.state.saveCaseModalVisible,
        caseName: currInterface.title,
        onCancel: function onCancel() {
          return _this3.setState({ saveCaseModalVisible: false });
        },
        onOk: this.saveCase
      })
    );
  };

  return Run;
}(_react.PureComponent), _class2.propTypes = {
  currProject: _propTypes2.default.object,
  currInterface: _propTypes2.default.object,
  match: _propTypes2.default.object,
  curUid: _propTypes2.default.number
}, _temp)) || _class) || _class);
exports.default = Run;