'use strict';

exports.__esModule = true;
exports.default = undefined;

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _message2 = require('antd/lib/message');

var _message3 = _interopRequireDefault(_message2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _dropdown = require('antd/lib/dropdown');

var _dropdown2 = _interopRequireDefault(_dropdown);

var _popover = require('antd/lib/popover');

var _popover2 = _interopRequireDefault(_popover);

var _tooltip = require('antd/lib/tooltip');

var _tooltip2 = _interopRequireDefault(_tooltip);

var _tag = require('antd/lib/tag');

var _tag2 = _interopRequireDefault(_tag);

var _menu = require('antd/lib/menu');

var _menu2 = _interopRequireDefault(_menu);

var _icon = require('antd/lib/icon');

var _icon2 = _interopRequireDefault(_icon);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _layout = require('antd/lib/layout');

var _layout2 = _interopRequireDefault(_layout);

var _dec, _class, _class2, _temp;

require('./Header.scss');

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _reactRedux = require('react-redux');

var _reactRouterDom = require('react-router-dom');

var _user = require('../../reducer/modules/user');

var _menu3 = require('../../reducer/modules/menu');

var _reactRouter = require('react-router');

var _Search = require('./Search/Search');

var _Search2 = _interopRequireDefault(_Search);

var _index = require('../LogoSVG/index.js');

var _index2 = _interopRequireDefault(_index);

var _Breadcrumb = require('../Breadcrumb/Breadcrumb.js');

var _Breadcrumb2 = _interopRequireDefault(_Breadcrumb);

var _GuideBtns = require('../GuideBtns/GuideBtns.js');

var _GuideBtns2 = _interopRequireDefault(_GuideBtns);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Header = _layout2.default.Header;

var plugin = require('../../plugin.js');

var HeaderMenu = {
  user: {
    path: '/user/profile',
    name: '个人中心',
    icon: 'user',
    adminFlag: false
  },
  solution: {
    path: '/user/list',
    name: '用户管理',
    icon: 'solution',
    adminFlag: true
  }
};

plugin.emitHook('header_menu', HeaderMenu);

var MenuUser = function MenuUser(props) {
  return _react2.default.createElement(
    _menu2.default,
    { theme: 'dark', className: 'user-menu' },
    (0, _keys2.default)(HeaderMenu).map(function (key) {
      var item = HeaderMenu[key];
      var isAdmin = props.role === 'admin';
      if (item.adminFlag && !isAdmin) {
        return null;
      }
      return _react2.default.createElement(
        _menu2.default.Item,
        { key: key },
        item.name === '个人中心' ? _react2.default.createElement(
          _reactRouterDom.Link,
          { to: item.path + ('/' + props.uid) },
          _react2.default.createElement(_icon2.default, { type: item.icon }),
          item.name
        ) : _react2.default.createElement(
          _reactRouterDom.Link,
          { to: item.path },
          _react2.default.createElement(_icon2.default, { type: item.icon }),
          item.name
        )
      );
    }),
    _react2.default.createElement(
      _menu2.default.Item,
      { key: '9' },
      _react2.default.createElement(
        'a',
        { onClick: props.logout },
        _react2.default.createElement(_icon2.default, { type: 'logout' }),
        '\u9000\u51FA'
      )
    )
  );
};

var tipFollow = _react2.default.createElement(
  'div',
  { className: 'title-container' },
  _react2.default.createElement(
    'h3',
    { className: 'title' },
    _react2.default.createElement(_icon2.default, { type: 'star' }),
    ' \u5173\u6CE8'
  ),
  _react2.default.createElement(
    'p',
    null,
    '\u8FD9\u91CC\u662F\u4F60\u7684\u4E13\u5C5E\u6536\u85CF\u5939\uFF0C\u4FBF\u4E8E\u4F60\u627E\u5230\u81EA\u5DF1\u7684\u9879\u76EE'
  )
);
var tipAdd = _react2.default.createElement(
  'div',
  { className: 'title-container' },
  _react2.default.createElement(
    'h3',
    { className: 'title' },
    _react2.default.createElement(_icon2.default, { type: 'plus-circle' }),
    ' \u65B0\u5EFA\u9879\u76EE'
  ),
  _react2.default.createElement(
    'p',
    null,
    '\u5728\u4EFB\u4F55\u9875\u9762\u90FD\u53EF\u4EE5\u5FEB\u901F\u65B0\u5EFA\u9879\u76EE'
  )
);
var tipDoc = _react2.default.createElement(
  'div',
  { className: 'title-container' },
  _react2.default.createElement(
    'h3',
    { className: 'title' },
    '\u4F7F\u7528\u6587\u6863 ',
    _react2.default.createElement(
      _tag2.default,
      { color: 'orange' },
      '\u63A8\u8350!'
    )
  ),
  _react2.default.createElement(
    'p',
    null,
    '\u521D\u6B21\u4F7F\u7528 YApi\uFF0C\u5F3A\u70C8\u5EFA\u8BAE\u4F60\u9605\u8BFB',
    ' ',
    _react2.default.createElement(
      'a',
      { target: '_blank', href: 'https://hellosean1025.github.io/yapi/', rel: 'noopener noreferrer' },
      '\u4F7F\u7528\u6587\u6863'
    ),
    '\uFF0C\u6211\u4EEC\u4E3A\u4F60\u63D0\u4F9B\u4E86\u901A\u4FD7\u6613\u61C2\u7684\u5FEB\u901F\u5165\u95E8\u6559\u7A0B\uFF0C\u66F4\u6709\u8BE6\u7EC6\u7684\u4F7F\u7528\u8BF4\u660E\uFF0C\u6B22\u8FCE\u9605\u8BFB\uFF01',
    ' '
  )
);

MenuUser.propTypes = {
  user: _propTypes2.default.string,
  msg: _propTypes2.default.string,
  role: _propTypes2.default.string,
  uid: _propTypes2.default.number,
  relieveLink: _propTypes2.default.func,
  logout: _propTypes2.default.func
};

var ToolUser = function ToolUser(props) {
  var imageUrl = props.imageUrl ? props.imageUrl : '/api/user/avatar?uid=' + props.uid;
  return _react2.default.createElement(
    'ul',
    null,
    _react2.default.createElement(
      'li',
      { className: 'toolbar-li item-search' },
      _react2.default.createElement(_Search2.default, { groupList: props.groupList })
    ),
    _react2.default.createElement(
      _popover2.default,
      {
        overlayClassName: 'popover-index',
        content: _react2.default.createElement(_GuideBtns2.default, null),
        title: tipFollow,
        placement: 'bottomRight',
        arrowPointAtCenter: true,
        visible: props.studyTip === 1 && !props.study
      },
      _react2.default.createElement(
        _tooltip2.default,
        { placement: 'bottom', title: '我的关注' },
        _react2.default.createElement(
          'li',
          { className: 'toolbar-li' },
          _react2.default.createElement(
            _reactRouterDom.Link,
            { to: '/follow' },
            _react2.default.createElement(_icon2.default, { className: 'dropdown-link', style: { fontSize: 16 }, type: 'star' })
          )
        )
      )
    ),
    _react2.default.createElement(
      _popover2.default,
      {
        overlayClassName: 'popover-index',
        content: _react2.default.createElement(_GuideBtns2.default, null),
        title: tipAdd,
        placement: 'bottomRight',
        arrowPointAtCenter: true,
        visible: props.studyTip === 2 && !props.study
      },
      _react2.default.createElement(
        _tooltip2.default,
        { placement: 'bottom', title: '新建项目' },
        _react2.default.createElement(
          'li',
          { className: 'toolbar-li' },
          _react2.default.createElement(
            _reactRouterDom.Link,
            { to: '/add-project' },
            _react2.default.createElement(_icon2.default, { className: 'dropdown-link', style: { fontSize: 16 }, type: 'plus-circle' })
          )
        )
      )
    ),
    _react2.default.createElement(
      _popover2.default,
      {
        overlayClassName: 'popover-index',
        content: _react2.default.createElement(_GuideBtns2.default, { isLast: true }),
        title: tipDoc,
        placement: 'bottomRight',
        arrowPointAtCenter: true,
        visible: props.studyTip === 3 && !props.study
      },
      _react2.default.createElement(
        _tooltip2.default,
        { placement: 'bottom', title: '使用文档' },
        _react2.default.createElement(
          'li',
          { className: 'toolbar-li' },
          _react2.default.createElement(
            'a',
            { target: '_blank', href: 'https://hellosean1025.github.io/yapi', rel: 'noopener noreferrer' },
            _react2.default.createElement(_icon2.default, { className: 'dropdown-link', style: { fontSize: 16 }, type: 'question-circle' })
          )
        )
      )
    ),
    _react2.default.createElement(
      'li',
      { className: 'toolbar-li' },
      _react2.default.createElement(
        _dropdown2.default,
        {
          placement: 'bottomRight',
          trigger: ['click'],
          overlay: _react2.default.createElement(MenuUser, {
            user: props.user,
            msg: props.msg,
            uid: props.uid,
            role: props.role,
            relieveLink: props.relieveLink,
            logout: props.logout
          })
        },
        _react2.default.createElement(
          'a',
          { className: 'dropdown-link' },
          _react2.default.createElement(
            'span',
            { className: 'avatar-image' },
            _react2.default.createElement('img', { src: imageUrl })
          ),
          _react2.default.createElement(
            'span',
            { className: 'name' },
            _react2.default.createElement(_icon2.default, { type: 'down' })
          )
        )
      )
    )
  );
};
ToolUser.propTypes = {
  user: _propTypes2.default.string,
  msg: _propTypes2.default.string,
  role: _propTypes2.default.string,
  uid: _propTypes2.default.number,
  relieveLink: _propTypes2.default.func,
  logout: _propTypes2.default.func,
  groupList: _propTypes2.default.array,
  studyTip: _propTypes2.default.number,
  study: _propTypes2.default.bool,
  imageUrl: _propTypes2.default.any
};

var HeaderCom = (_dec = (0, _reactRedux.connect)(function (state) {
  return {
    user: state.user.userName,
    uid: state.user.uid,
    msg: null,
    role: state.user.role,
    login: state.user.isLogin,
    studyTip: state.user.studyTip,
    study: state.user.study,
    imageUrl: state.user.imageUrl
  };
}, {
  loginTypeAction: _user.loginTypeAction,
  logoutActions: _user.logoutActions,
  checkLoginState: _user.checkLoginState,
  changeMenuItem: _menu3.changeMenuItem
}), _dec(_class = (0, _reactRouter.withRouter)(_class = (_temp = _class2 = function (_Component) {
  (0, _inherits3.default)(HeaderCom, _Component);

  function HeaderCom(props) {
    (0, _classCallCheck3.default)(this, HeaderCom);

    var _this = (0, _possibleConstructorReturn3.default)(this, _Component.call(this, props));

    _this.linkTo = function (e) {
      if (e.key != '/doc') {
        _this.props.changeMenuItem(e.key);
        if (!_this.props.login) {
          _message3.default.info('请先登录', 1);
        }
      }
    };

    _this.relieveLink = function () {
      _this.props.changeMenuItem('');
    };

    _this.logout = function (e) {
      e.preventDefault();
      _this.props.logoutActions().then(function (res) {
        if (res.payload.data.errcode == 0) {
          _this.props.history.push('/');
          _this.props.changeMenuItem('/');
          _message3.default.success('退出成功! ');
        } else {
          _message3.default.error(res.payload.data.errmsg);
        }
      }).catch(function (err) {
        _message3.default.error(err);
      });
    };

    _this.handleLogin = function (e) {
      e.preventDefault();
      _this.props.loginTypeAction('1');
    };

    _this.handleReg = function (e) {
      e.preventDefault();
      _this.props.loginTypeAction('2');
    };

    _this.checkLoginState = function () {
      _this.props.checkLoginState.then(function (res) {
        if (res.payload.data.errcode !== 0) {
          _this.props.history.push('/');
        }
      }).catch(function (err) {
        console.log(err);
      });
    };

    return _this;
  }

  HeaderCom.prototype.render = function render() {
    var _props = this.props,
        login = _props.login,
        user = _props.user,
        msg = _props.msg,
        uid = _props.uid,
        role = _props.role,
        studyTip = _props.studyTip,
        study = _props.study,
        imageUrl = _props.imageUrl;

    return _react2.default.createElement(
      Header,
      { className: 'header-box m-header' },
      _react2.default.createElement(
        'div',
        { className: 'content g-row' },
        _react2.default.createElement(
          _reactRouterDom.Link,
          { onClick: this.relieveLink, to: '/group', className: 'logo' },
          _react2.default.createElement(
            'div',
            { className: 'href' },
            _react2.default.createElement(
              'span',
              { className: 'img' },
              _react2.default.createElement(_index2.default, { length: '32px' })
            )
          )
        ),
        _react2.default.createElement(_Breadcrumb2.default, null),
        _react2.default.createElement(
          'div',
          {
            className: 'user-toolbar',
            style: { position: 'relative', zIndex: this.props.studyTip > 0 ? 3 : 1 }
          },
          login ? _react2.default.createElement(ToolUser, (0, _extends3.default)({ studyTip: studyTip, study: study, user: user, msg: msg, uid: uid, role: role, imageUrl: imageUrl }, {
            relieveLink: this.relieveLink,
            logout: this.logout
          })) : ''
        )
      )
    );
  };

  return HeaderCom;
}(_react.PureComponent), _class2.propTypes = {
  router: _propTypes2.default.object,
  user: _propTypes2.default.string,
  msg: _propTypes2.default.string,
  uid: _propTypes2.default.number,
  role: _propTypes2.default.string,
  login: _propTypes2.default.bool,
  relieveLink: _propTypes2.default.func,
  logoutActions: _propTypes2.default.func,
  checkLoginState: _propTypes2.default.func,
  loginTypeAction: _propTypes2.default.func,
  changeMenuItem: _propTypes2.default.func,
  history: _propTypes2.default.object,
  location: _propTypes2.default.object,
  study: _propTypes2.default.bool,
  studyTip: _propTypes2.default.number,
  imageUrl: _propTypes2.default.any
}, _temp)) || _class) || _class);
exports.default = HeaderCom;