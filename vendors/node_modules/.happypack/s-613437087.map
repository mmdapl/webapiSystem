{"version":3,"sources":["client\\containers\\Project\\Interface\\InterfaceList\\Edit.js"],"names":["InterfaceEdit","curdata","state","inter","currProject","project","updateInterfaceData","fetchInterfaceListMenu","fetchInterfaceData","getProject","props","onSubmit","params","id","match","actionId","axios","post","result","_id","then","data","errcode","success","error","errmsg","onTagClick","setState","visible","handleOk","tag","filter","val","name","handleCancel","tagSubmit","tagRef","mockUrl","location","protocol","hostname","port","basepath","path","status","componentWillUnmount","WebSocket","close","e","componentDidMount","domain","s","initData","wsProtocol","setTimeout","onopen","onmessage","JSON","parse","errno","onerror","console","warn","render","cat","switch_notice","textAlign","fontSize","paddingTop","uid","username","Component","propTypes","PropTypes","object","func","switchToView"],"mappings":"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","file":"Edit.js","sourceRoot":"C:/Users/DUOYI/Desktop/api/test/vendors","sourcesContent":["import React, { PureComponent as Component } from 'react';\nimport PropTypes from 'prop-types';\nimport { connect } from 'react-redux';\nimport InterfaceEditForm from './InterfaceEditForm.js';\nimport {\n  updateInterfaceData,\n  fetchInterfaceListMenu,\n  fetchInterfaceData\n} from '../../../../reducer/modules/interface.js';\nimport { getProject } from '../../../../reducer/modules/project.js';\nimport axios from 'axios';\nimport { message, Modal } from 'antd';\nimport './Edit.scss';\nimport { withRouter, Link } from 'react-router-dom';\nimport ProjectTag from '../../Setting/ProjectMessage/ProjectTag.js';\n\n@connect(\n  state => {\n    return {\n      curdata: state.inter.curdata,\n      currProject: state.project.currProject\n    };\n  },\n  {\n    updateInterfaceData,\n    fetchInterfaceListMenu,\n    fetchInterfaceData,\n    getProject\n  }\n)\nclass InterfaceEdit extends Component {\n  static propTypes = {\n    curdata: PropTypes.object,\n    currProject: PropTypes.object,\n    updateInterfaceData: PropTypes.func,\n    fetchInterfaceListMenu: PropTypes.func,\n    fetchInterfaceData: PropTypes.func,\n    match: PropTypes.object,\n    switchToView: PropTypes.func,\n    getProject: PropTypes.func\n  };\n\n  constructor(props) {\n    super(props);\n    const { curdata, currProject } = this.props;\n    this.state = {\n      mockUrl:\n        location.protocol +\n        '//' +\n        location.hostname +\n        (location.port !== '' ? ':' + location.port : '') +\n        `/mock/${currProject._id}${currProject.basepath}${curdata.path}`,\n      curdata: {},\n      status: 0,\n      visible: false\n      // tag: []\n    };\n  }\n\n  onSubmit = async params => {\n    params.id = this.props.match.params.actionId;\n    let result = await axios.post('/api/interface/up', params);\n    this.props.fetchInterfaceListMenu(this.props.currProject._id).then();\n    this.props.fetchInterfaceData(params.id).then();\n    if (result.data.errcode === 0) {\n      this.props.updateInterfaceData(params);\n      message.success('保存成功');\n    } else {\n      message.error(result.data.errmsg);\n    }\n  };\n\n  componentWillUnmount() {\n    try {\n      if (this.state.status === 1) {\n        this.WebSocket.close();\n      }\n    } catch (e) {\n      return null;\n    }\n  }\n\n  componentDidMount() {\n    let domain = location.hostname + (location.port !== '' ? ':' + location.port : '');\n    let s,\n      initData = false;\n    //因后端 node 仅支持 ws， 暂不支持 wss\n    let wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';\n\n    setTimeout(() => {\n      if (initData === false) {\n        this.setState({\n          curdata: this.props.curdata,\n          status: 1\n        });\n        initData = true;\n      }\n    }, 3000);\n\n    try {\n      s = new WebSocket(\n        wsProtocol +\n          '://' +\n          domain +\n          '/api/interface/solve_conflict?id=' +\n          this.props.match.params.actionId\n      );\n      s.onopen = () => {\n        this.WebSocket = s;\n      };\n\n      s.onmessage = e => {\n        initData = true;\n        let result = JSON.parse(e.data);\n        if (result.errno === 0) {\n          this.setState({\n            curdata: result.data,\n            status: 1\n          });\n        } else {\n          this.setState({\n            curdata: result.data,\n            status: 2\n          });\n        }\n      };\n\n      s.onerror = () => {\n        this.setState({\n          curdata: this.props.curdata,\n          status: 1\n        });\n        console.warn('websocket 连接失败，将导致多人编辑同一个接口冲突。');\n      };\n    } catch (e) {\n      this.setState({\n        curdata: this.props.curdata,\n        status: 1\n      });\n      console.error('websocket 连接失败，将导致多人编辑同一个接口冲突。');\n    }\n  }\n\n  onTagClick = () => {\n    this.setState({\n      visible: true\n    });\n  };\n\n  handleOk = async () => {\n    let { tag } = this.tag.state;\n    tag = tag.filter(val => {\n      return val.name !== '';\n    });\n\n    let id = this.props.currProject._id;\n    let params = {\n      id,\n      tag\n    };\n    let result = await axios.post('/api/project/up_tag', params);\n\n    if (result.data.errcode === 0) {\n      await this.props.getProject(id);\n      message.success('保存成功');\n    } else {\n      message.error(result.data.errmsg);\n    }\n\n    this.setState({\n      visible: false\n    });\n  };\n\n  handleCancel = () => {\n    this.setState({\n      visible: false\n    });\n  };\n\n  tagSubmit = tagRef => {\n    this.tag = tagRef;\n\n    // this.setState({tag})\n  };\n\n  render() {\n    const { cat, basepath, switch_notice, tag } = this.props.currProject;\n    return (\n      <div className=\"interface-edit\">\n        {this.state.status === 1 ? (\n          <InterfaceEditForm\n            cat={cat}\n            mockUrl={this.state.mockUrl}\n            basepath={basepath}\n            noticed={switch_notice}\n            onSubmit={this.onSubmit}\n            curdata={this.state.curdata}\n            onTagClick={this.onTagClick}\n          />\n        ) : null}\n        {this.state.status === 2 ? (\n          <div style={{ textAlign: 'center', fontSize: '14px', paddingTop: '10px' }}>\n            <Link to={'/user/profile/' + this.state.curdata.uid}>\n              <b>{this.state.curdata.username}</b>\n            </Link>\n            <span>正在编辑该接口，请稍后再试...</span>\n          </div>\n        ) : null}\n        {this.state.status === 0 && '正在加载，请耐心等待...'}\n\n        <Modal\n          title=\"Tag 设置\"\n          width={680}\n          visible={this.state.visible}\n          onOk={this.handleOk}\n          onCancel={this.handleCancel}\n          okText=\"保存\"\n        >\n          <div className=\"tag-modal-center\">\n            <ProjectTag tagMsg={tag} ref={this.tagSubmit} />\n          </div>\n        </Modal>\n      </div>\n    );\n  }\n}\n\nexport default withRouter(InterfaceEdit);\n"]}