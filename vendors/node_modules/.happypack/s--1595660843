'use strict';

exports.__esModule = true;

var _button = require('antd/lib/button');

var _button2 = _interopRequireDefault(_button);

var _tooltip = require('antd/lib/tooltip');

var _tooltip2 = _interopRequireDefault(_tooltip);

var _row = require('antd/lib/row');

var _row2 = _interopRequireDefault(_row);

var _icon = require('antd/lib/icon');

var _icon2 = _interopRequireDefault(_icon);

var _input = require('antd/lib/input');

var _input2 = _interopRequireDefault(_input);

var _col = require('antd/lib/col');

var _col2 = _interopRequireDefault(_col);

var _autoComplete = require('antd/lib/auto-complete');

var _autoComplete2 = _interopRequireDefault(_autoComplete);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _typeof2 = require('babel-runtime/helpers/typeof');

var _typeof3 = _interopRequireDefault(_typeof2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _select = require('antd/lib/select');

var _select2 = _interopRequireDefault(_select);

var _form = require('antd/lib/form');

var _form2 = _interopRequireDefault(_form);

var _class, _temp;

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

require('./index.scss');

var _variable = require('../../../../constants/variable.js');

var _variable2 = _interopRequireDefault(_variable);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var FormItem = _form2.default.Item;
var Option = _select2.default.Option;


var initMap = {
  header: [{
    name: '',
    value: ''
  }],
  cookie: [{
    name: '',
    value: ''
  }],
  global: [{
    name: '',
    value: ''
  }]
};

var ProjectEnvContent = (_temp = _class = function (_Component) {
  (0, _inherits3.default)(ProjectEnvContent, _Component);

  ProjectEnvContent.prototype.initState = function initState(curdata) {
    var header = [{
      name: '',
      value: ''
    }];
    var cookie = [{
      name: '',
      value: ''
    }];

    var global = [{
      name: '',
      value: ''
    }];

    var curheader = curdata.header;
    var curGlobal = curdata.global;

    if (curheader && curheader.length !== 0) {
      curheader.forEach(function (item) {
        if (item.name === 'Cookie') {
          var cookieStr = item.value;
          if (cookieStr) {
            cookieStr = cookieStr.split(';').forEach(function (c) {
              if (c) {
                c = c.split('=');
                cookie.unshift({
                  name: c[0] ? c[0].trim() : '',
                  value: c[1] ? c[1].trim() : ''
                });
              }
            });
          }
        } else {
          header.unshift(item);
        }
      });
    }

    if (curGlobal && curGlobal.length !== 0) {
      curGlobal.forEach(function (item) {
        global.unshift(item);
      });
    }
    return { header: header, cookie: cookie, global: global };
  };

  function ProjectEnvContent(props) {
    (0, _classCallCheck3.default)(this, ProjectEnvContent);

    var _this = (0, _possibleConstructorReturn3.default)(this, _Component.call(this, props));

    _this.addHeader = function (value, index, name) {
      var nextHeader = _this.state[name][index + 1];
      if (nextHeader && (typeof nextHeader === 'undefined' ? 'undefined' : (0, _typeof3.default)(nextHeader)) === 'object') {
        return;
      }
      var newValue = {};
      var data = { name: '', value: '' };
      newValue[name] = [].concat(_this.state[name], data);
      _this.setState(newValue);
    };

    _this.delHeader = function (key, name) {
      var curValue = _this.props.form.getFieldValue(name);
      var newValue = {};
      newValue[name] = curValue.filter(function (val, index) {
        return index !== key;
      });
      _this.props.form.setFieldsValue(newValue);
      _this.setState(newValue);
    };

    _this.handleOk = function (e) {
      e.preventDefault();
      var _this$props = _this.props,
          form = _this$props.form,
          onSubmit = _this$props.onSubmit,
          projectMsg = _this$props.projectMsg;

      form.validateFields(function (err, values) {
        if (!err) {
          var header = values.header.filter(function (val) {
            return val.name !== '';
          });
          var cookie = values.cookie.filter(function (val) {
            return val.name !== '';
          });
          var global = values.global.filter(function (val) {
            return val.name !== '';
          });
          if (cookie.length > 0) {
            header.push({
              name: 'Cookie',
              value: cookie.map(function (item) {
                return item.name + '=' + item.value;
              }).join(';')
            });
          }
          var assignValue = {};
          assignValue.env = (0, _assign2.default)({ _id: projectMsg._id }, {
            name: values.env.name,
            domain: values.env.protocol + values.env.domain,
            header: header,
            global: global
          });
          onSubmit(assignValue);
        }
      });
    };

    _this.state = (0, _assign2.default)({}, initMap);
    return _this;
  }

  ProjectEnvContent.prototype.handleInit = function handleInit(data) {
    this.props.form.resetFields();
    var newValue = this.initState(data);
    this.setState((0, _extends3.default)({}, newValue));
  };

  ProjectEnvContent.prototype.componentWillReceiveProps = function componentWillReceiveProps(nextProps) {
    var curEnvName = this.props.projectMsg.name;
    var nextEnvName = nextProps.projectMsg.name;
    if (curEnvName !== nextEnvName) {
      this.handleInit(nextProps.projectMsg);
    }
  };

  ProjectEnvContent.prototype.render = function render() {
    var _this2 = this;

    var projectMsg = this.props.projectMsg;
    var getFieldDecorator = this.props.form.getFieldDecorator;

    var headerTpl = function headerTpl(item, index) {
      var headerLength = _this2.state.header.length - 1;
      return _react2.default.createElement(
        _row2.default,
        { gutter: 2, key: index },
        _react2.default.createElement(
          _col2.default,
          { span: 10 },
          _react2.default.createElement(
            FormItem,
            null,
            getFieldDecorator('header[' + index + '].name', {
              validateTrigger: ['onChange', 'onBlur'],
              initialValue: item.name || ''
            })(_react2.default.createElement(_autoComplete2.default, {
              style: { width: '200px' },
              allowClear: true,
              dataSource: _variable2.default.HTTP_REQUEST_HEADER,
              placeholder: '\u8BF7\u8F93\u5165header\u540D\u79F0',
              onChange: function onChange() {
                return _this2.addHeader(item, index, 'header');
              },
              filterOption: function filterOption(inputValue, option) {
                return option.props.children.toUpperCase().indexOf(inputValue.toUpperCase()) !== -1;
              }
            }))
          )
        ),
        _react2.default.createElement(
          _col2.default,
          { span: 12 },
          _react2.default.createElement(
            FormItem,
            null,
            getFieldDecorator('header[' + index + '].value', {
              validateTrigger: ['onChange', 'onBlur'],
              initialValue: item.value || ''
            })(_react2.default.createElement(_input2.default, { placeholder: '\u8BF7\u8F93\u5165\u53C2\u6570\u5185\u5BB9', style: { width: '90%', marginRight: 8 } }))
          )
        ),
        _react2.default.createElement(
          _col2.default,
          { span: 2, className: index === headerLength ? ' env-last-row' : null },
          _react2.default.createElement(_icon2.default, {
            className: 'dynamic-delete-button delete',
            type: 'delete',
            onClick: function onClick(e) {
              e.stopPropagation();
              _this2.delHeader(index, 'header');
            }
          })
        )
      );
    };

    var commonTpl = function commonTpl(item, index, name) {
      var length = _this2.state[name].length - 1;
      return _react2.default.createElement(
        _row2.default,
        { gutter: 2, key: index },
        _react2.default.createElement(
          _col2.default,
          { span: 10 },
          _react2.default.createElement(
            FormItem,
            null,
            getFieldDecorator(name + '[' + index + '].name', {
              validateTrigger: ['onChange', 'onBlur'],
              initialValue: item.name || ''
            })(_react2.default.createElement(_input2.default, {
              placeholder: '\u8BF7\u8F93\u5165 ' + name + ' Name',
              style: { width: '200px' },
              onChange: function onChange() {
                return _this2.addHeader(item, index, name);
              }
            }))
          )
        ),
        _react2.default.createElement(
          _col2.default,
          { span: 12 },
          _react2.default.createElement(
            FormItem,
            null,
            getFieldDecorator(name + '[' + index + '].value', {
              validateTrigger: ['onChange', 'onBlur'],
              initialValue: item.value || ''
            })(_react2.default.createElement(_input2.default, { placeholder: '\u8BF7\u8F93\u5165\u53C2\u6570\u5185\u5BB9', style: { width: '90%', marginRight: 8 } }))
          )
        ),
        _react2.default.createElement(
          _col2.default,
          { span: 2, className: index === length ? ' env-last-row' : null },
          _react2.default.createElement(_icon2.default, {
            className: 'dynamic-delete-button delete',
            type: 'delete',
            onClick: function onClick(e) {
              e.stopPropagation();
              _this2.delHeader(index, name);
            }
          })
        )
      );
    };

    var envTpl = function envTpl(data) {
      return _react2.default.createElement(
        'div',
        null,
        _react2.default.createElement(
          'h3',
          { className: 'env-label' },
          '\u73AF\u5883\u540D\u79F0'
        ),
        _react2.default.createElement(
          FormItem,
          { required: false },
          getFieldDecorator('env.name', {
            validateTrigger: ['onChange', 'onBlur'],
            initialValue: data.name === '新环境' ? '' : data.name || '',
            rules: [{
              required: false,
              whitespace: true,
              validator: function validator(rule, value, callback) {
                if (value) {
                  if (value.length === 0) {
                    callback('请输入环境名称');
                  } else if (!/\S/.test(value)) {
                    callback('请输入环境名称');
                  } else {
                    return callback();
                  }
                } else {
                  callback('请输入环境名称');
                }
              }
            }]
          })(_react2.default.createElement(_input2.default, {
            onChange: function onChange(e) {
              return _this2.props.handleEnvInput(e.target.value);
            },
            placeholder: '\u8BF7\u8F93\u5165\u73AF\u5883\u540D\u79F0',
            style: { width: '90%', marginRight: 8 }
          }))
        ),
        _react2.default.createElement(
          'h3',
          { className: 'env-label' },
          '\u73AF\u5883\u57DF\u540D'
        ),
        _react2.default.createElement(
          FormItem,
          { required: false },
          getFieldDecorator('env.domain', {
            validateTrigger: ['onChange', 'onBlur'],
            initialValue: data.domain ? data.domain.split('//')[1] : '',
            rules: [{
              required: false,
              whitespace: true,
              validator: function validator(rule, value, callback) {
                if (value) {
                  if (value.length === 0) {
                    callback('请输入环境域名!');
                  } else if (/\s/.test(value)) {
                    callback('环境域名不允许出现空格!');
                  } else {
                    return callback();
                  }
                } else {
                  callback('请输入环境域名!');
                }
              }
            }]
          })(_react2.default.createElement(_input2.default, {
            placeholder: '\u8BF7\u8F93\u5165\u73AF\u5883\u57DF\u540D',
            style: { width: '90%', marginRight: 8 },
            addonBefore: getFieldDecorator('env.protocol', {
              initialValue: data.domain ? data.domain.split('//')[0] + '//' : 'http://',
              rules: [{
                required: true
              }]
            })(_react2.default.createElement(
              _select2.default,
              null,
              _react2.default.createElement(
                Option,
                { value: 'http://' },
                'http://'
              ),
              _react2.default.createElement(
                Option,
                { value: 'https://' },
                'https://'
              )
            ))
          }))
        ),
        _react2.default.createElement(
          'h3',
          { className: 'env-label' },
          'Header'
        ),
        _this2.state.header.map(function (item, index) {
          return headerTpl(item, index);
        }),
        _react2.default.createElement(
          'h3',
          { className: 'env-label' },
          'Cookie'
        ),
        _this2.state.cookie.map(function (item, index) {
          return commonTpl(item, index, 'cookie');
        }),
        _react2.default.createElement(
          'h3',
          { className: 'env-label' },
          'global',
          _react2.default.createElement(
            'a',
            {
              target: '_blank',
              rel: 'noopener noreferrer',
              href: 'https://hellosean1025.github.io/yapi/documents/project.html#%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83',
              style: { marginLeft: 8 }
            },
            _react2.default.createElement(
              _tooltip2.default,
              { title: '\u70B9\u51FB\u67E5\u770B\u6587\u6863' },
              _react2.default.createElement(_icon2.default, { type: 'question-circle-o', style: { fontSize: '13px' } })
            )
          )
        ),
        _this2.state.global.map(function (item, index) {
          return commonTpl(item, index, 'global');
        })
      );
    };

    return _react2.default.createElement(
      'div',
      null,
      envTpl(projectMsg),
      _react2.default.createElement(
        'div',
        { className: 'btnwrap-changeproject' },
        _react2.default.createElement(
          _button2.default,
          {
            className: 'm-btn btn-save',
            icon: 'save',
            type: 'primary',
            size: 'large',
            onClick: this.handleOk
          },
          '\u4FDD \u5B58'
        )
      )
    );
  };

  return ProjectEnvContent;
}(_react.Component), _class.propTypes = {
  projectMsg: _propTypes2.default.object,
  form: _propTypes2.default.object,
  onSubmit: _propTypes2.default.func,
  handleEnvInput: _propTypes2.default.func
}, _temp);
exports.default = _form2.default.create()(ProjectEnvContent);