'use strict';

exports.__esModule = true;

var _row = require('antd/lib/row');

var _row2 = _interopRequireDefault(_row);

var _col = require('antd/lib/col');

var _col2 = _interopRequireDefault(_col);

var _modal = require('antd/lib/modal');

var _modal2 = _interopRequireDefault(_modal);

var _spin = require('antd/lib/spin');

var _spin2 = _interopRequireDefault(_spin);

var _timeline = require('antd/lib/timeline');

var _timeline2 = _interopRequireDefault(_timeline);

var _button = require('antd/lib/button');

var _button2 = _interopRequireDefault(_button);

var _avatar = require('antd/lib/avatar');

var _avatar2 = _interopRequireDefault(_avatar);

var _typeof2 = require('babel-runtime/helpers/typeof');

var _typeof3 = _interopRequireDefault(_typeof2);

var _tag = require('antd/lib/tag');

var _tag2 = _interopRequireDefault(_tag);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _autoComplete = require('antd/lib/auto-complete');

var _autoComplete2 = _interopRequireDefault(_autoComplete);

var _dec, _class, _class2, _temp;

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _reactRedux = require('react-redux');

var _common = require('../../common.js');

var _diffView = require('../../../common/diff-view.js');

var _diffView2 = _interopRequireDefault(_diffView);

var _variable = require('../../constants/variable');

var _variable2 = _interopRequireDefault(_variable);

var _reactRouterDom = require('react-router-dom');

var _news = require('../../reducer/modules/news.js');

var _interface = require('../../reducer/modules/interface.js');

var _ErrMsg = require('../ErrMsg/ErrMsg.js');

var _ErrMsg2 = _interopRequireDefault(_ErrMsg);

require('jsondiffpatch/dist/formatters-styles/annotated.css');

require('jsondiffpatch/dist/formatters-styles/html.css');

require('./TimeLine.scss');

var _utils = require('../../../common/utils.js');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var jsondiffpatch = require('jsondiffpatch/dist/jsondiffpatch.umd.js');
var formattersHtml = jsondiffpatch.formatters.html;


// const Option = AutoComplete.Option;
var Option = _autoComplete2.default.Option,
    OptGroup = _autoComplete2.default.OptGroup;


var AddDiffView = function AddDiffView(props) {
  var title = props.title,
      content = props.content,
      className = props.className;


  if (!content) {
    return null;
  }

  return _react2.default.createElement(
    'div',
    { className: className },
    _react2.default.createElement(
      'h3',
      { className: 'title' },
      title
    ),
    _react2.default.createElement('div', { dangerouslySetInnerHTML: { __html: content } })
  );
};

AddDiffView.propTypes = {
  title: _propTypes2.default.string,
  content: _propTypes2.default.string,
  className: _propTypes2.default.string
};

// timeago(new Date().getTime() - 40);

var TimeTree = (_dec = (0, _reactRedux.connect)(function (state) {
  return {
    newsData: state.news.newsData,
    curpage: state.news.curpage,
    curUid: state.user.uid
  };
}, {
  fetchNewsData: _news.fetchNewsData,
  fetchMoreNews: _news.fetchMoreNews,
  fetchInterfaceList: _interface.fetchInterfaceList
}), _dec(_class = (_temp = _class2 = function (_Component) {
  (0, _inherits3.default)(TimeTree, _Component);

  function TimeTree(props) {
    (0, _classCallCheck3.default)(this, TimeTree);

    var _this = (0, _possibleConstructorReturn3.default)(this, _Component.call(this, props));

    _this.handleCancel = function () {
      _this.setState({
        visible: false
      });
    };

    _this.openDiff = function (data) {
      _this.setState({
        curDiffData: data,
        visible: true
      });
    };

    _this.handleSelectApi = function (selectValue) {
      _this.curSelectValue = selectValue;
      _this.props.fetchNewsData(_this.props.typeid, _this.props.type, 1, 10, selectValue);
    };

    _this.state = {
      bidden: '',
      loading: false,
      visible: false,
      curDiffData: {},
      apiList: []
    };
    _this.curSelectValue = '';
    return _this;
  }

  TimeTree.prototype.getMore = function getMore() {
    var that = this;

    if (this.props.curpage <= this.props.newsData.total) {
      this.setState({ loading: true });
      this.props.fetchMoreNews(this.props.typeid, this.props.type, this.props.curpage + 1, 10, this.curSelectValue).then(function () {
        that.setState({ loading: false });
        if (that.props.newsData.total === that.props.curpage) {
          that.setState({ bidden: 'logbidden' });
        }
      });
    }
  };

  TimeTree.prototype.componentWillMount = function componentWillMount() {
    this.props.fetchNewsData(this.props.typeid, this.props.type, 1, 10);
    if (this.props.type === 'project') {
      this.getApiList();
    }
  };

  TimeTree.prototype.getApiList = function () {
    var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {
      var result;
      return _regenerator2.default.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              _context.next = 2;
              return this.props.fetchInterfaceList({
                project_id: this.props.typeid,
                limit: 'all'
              });

            case 2:
              result = _context.sent;

              this.setState({
                apiList: result.payload.data.data.list
              });

            case 4:
            case 'end':
              return _context.stop();
          }
        }
      }, _callee, this);
    }));

    function getApiList() {
      return _ref.apply(this, arguments);
    }

    return getApiList;
  }();

  TimeTree.prototype.render = function render() {
    var _this2 = this;

    var data = this.props.newsData ? this.props.newsData.list : [];

    var curDiffData = this.state.curDiffData;
    var logType = {
      project: '项目',
      group: '分组',
      interface: '接口',
      interface_col: '接口集',
      user: '用户',
      other: '其他'
    };

    var children = this.state.apiList.map(function (item) {
      var methodColor = _variable2.default.METHOD_COLOR[item.method ? item.method.toLowerCase() : 'get'];
      return _react2.default.createElement(
        Option,
        { title: item.title, value: item._id + '', path: item.path, key: item._id },
        item.title,
        ' ',
        _react2.default.createElement(
          _tag2.default,
          {
            style: { color: methodColor ? methodColor.color : '#cfefdf', backgroundColor: methodColor ? methodColor.bac : '#00a854', border: 'unset' }
          },
          item.method
        )
      );
    });

    children.unshift(_react2.default.createElement(
      Option,
      { value: '', key: 'all' },
      '\u9009\u62E9\u5168\u90E8'
    ));

    if (data && data.length) {
      data = data.map(function (item, i) {
        var interfaceDiff = false;
        // 去掉了 && item.data.interface_id
        if (item.data && (0, _typeof3.default)(item.data) === 'object') {
          interfaceDiff = true;
        }
        return _react2.default.createElement(
          _timeline2.default.Item,
          {
            dot: _react2.default.createElement(
              _reactRouterDom.Link,
              { to: '/user/profile/' + item.uid },
              _react2.default.createElement(_avatar2.default, { src: '/api/user/avatar?uid=' + item.uid })
            ),
            key: i
          },
          _react2.default.createElement(
            'div',
            { className: 'logMesHeade' },
            _react2.default.createElement(
              'span',
              { className: 'logoTimeago' },
              (0, _utils.timeago)(item.add_time)
            ),
            _react2.default.createElement(
              'span',
              { className: 'logtype' },
              logType[item.type],
              '\u52A8\u6001'
            ),
            _react2.default.createElement(
              'span',
              { className: 'logtime' },
              (0, _common.formatTime)(item.add_time)
            )
          ),
          _react2.default.createElement('span', { className: 'logcontent', dangerouslySetInnerHTML: { __html: item.content } }),
          _react2.default.createElement(
            'div',
            { style: { padding: '10px 0 0 10px' } },
            interfaceDiff && _react2.default.createElement(
              _button2.default,
              { onClick: function onClick() {
                  return _this2.openDiff(item.data);
                } },
              '\u6539\u52A8\u8BE6\u60C5'
            )
          )
        );
      });
    } else {
      data = '';
    }
    var pending = this.props.newsData.total <= this.props.curpage ? _react2.default.createElement(
      'a',
      { className: 'logbidden' },
      '\u4EE5\u4E0A\u4E3A\u5168\u90E8\u5185\u5BB9'
    ) : _react2.default.createElement(
      'a',
      { className: 'loggetMore', onClick: this.getMore.bind(this) },
      '\u67E5\u770B\u66F4\u591A'
    );
    if (this.state.loading) {
      pending = _react2.default.createElement(_spin2.default, null);
    }
    var diffView = (0, _diffView2.default)(jsondiffpatch, formattersHtml, curDiffData);

    return _react2.default.createElement(
      'section',
      { className: 'news-timeline' },
      _react2.default.createElement(
        _modal2.default,
        {
          style: { minWidth: '800px' },
          title: 'Api \u6539\u52A8\u65E5\u5FD7',
          visible: this.state.visible,
          footer: null,
          onCancel: this.handleCancel
        },
        _react2.default.createElement(
          'i',
          null,
          '\u6CE8\uFF1A \u7EFF\u8272\u4EE3\u8868\u65B0\u589E\u5185\u5BB9\uFF0C\u7EA2\u8272\u4EE3\u8868\u5220\u9664\u5185\u5BB9'
        ),
        _react2.default.createElement(
          'div',
          { className: 'project-interface-change-content' },
          diffView.map(function (item, index) {
            return _react2.default.createElement(AddDiffView, {
              className: 'item-content',
              title: item.title,
              key: index,
              content: item.content
            });
          }),
          diffView.length === 0 && _react2.default.createElement(_ErrMsg2.default, { type: 'noChange' })
        )
      ),
      this.props.type === 'project' && _react2.default.createElement(
        _row2.default,
        { className: 'news-search' },
        _react2.default.createElement(
          _col2.default,
          { span: '3' },
          '\u9009\u62E9\u67E5\u8BE2\u7684 Api\uFF1A'
        ),
        _react2.default.createElement(
          _col2.default,
          { span: '10' },
          _react2.default.createElement(
            _autoComplete2.default,
            {
              onSelect: this.handleSelectApi,
              style: { width: '100%' },
              placeholder: 'Select Api',
              optionLabelProp: 'title',
              filterOption: function filterOption(inputValue, options) {
                if (options.props.value == '') return true;
                if (options.props.path.indexOf(inputValue) !== -1 || options.props.title.indexOf(inputValue) !== -1) {
                  return true;
                }
                return false;
              }
            },
            _react2.default.createElement(
              OptGroup,
              { label: 'other' },
              _react2.default.createElement(
                Option,
                { value: 'wiki', path: '', title: 'wiki' },
                'wiki'
              )
            ),
            _react2.default.createElement(
              OptGroup,
              { label: 'api' },
              children
            )
          )
        )
      ),
      data ? _react2.default.createElement(
        _timeline2.default,
        { className: 'news-content', pending: pending },
        data
      ) : _react2.default.createElement(_ErrMsg2.default, { type: 'noData' })
    );
  };

  return TimeTree;
}(_react.PureComponent), _class2.propTypes = {
  newsData: _propTypes2.default.object,
  fetchNewsData: _propTypes2.default.func,
  fetchMoreNews: _propTypes2.default.func,
  setLoading: _propTypes2.default.func,
  loading: _propTypes2.default.bool,
  curpage: _propTypes2.default.number,
  typeid: _propTypes2.default.number,
  curUid: _propTypes2.default.number,
  type: _propTypes2.default.string,
  fetchInterfaceList: _propTypes2.default.func
}, _temp)) || _class);
exports.default = TimeTree;