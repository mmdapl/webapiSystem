'use strict';

exports.__esModule = true;

var _tooltip = require('antd/lib/tooltip');

var _tooltip2 = _interopRequireDefault(_tooltip);

var _row = require('antd/lib/row');

var _row2 = _interopRequireDefault(_row);

var _popconfirm = require('antd/lib/popconfirm');

var _popconfirm2 = _interopRequireDefault(_popconfirm);

var _icon = require('antd/lib/icon');

var _icon2 = _interopRequireDefault(_icon);

var _message2 = require('antd/lib/message');

var _message3 = _interopRequireDefault(_message2);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _layout = require('antd/lib/layout');

var _layout2 = _interopRequireDefault(_layout);

var _dec, _class, _class2, _temp;

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

require('./index.scss');

var _ProjectEnvContent = require('./ProjectEnvContent.js');

var _ProjectEnvContent2 = _interopRequireDefault(_ProjectEnvContent);

var _reactRedux = require('react-redux');

var _project = require('../../../../reducer/modules/project');

var _EasyDragSort = require('../../../../components/EasyDragSort/EasyDragSort.js');

var _EasyDragSort2 = _interopRequireDefault(_EasyDragSort);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Content = _layout2.default.Content,
    Sider = _layout2.default.Sider;
var ProjectEnv = (_dec = (0, _reactRedux.connect)(function (state) {
  return {
    projectMsg: state.project.currProject
  };
}, {
  updateEnv: _project.updateEnv,
  getProject: _project.getProject,
  getEnv: _project.getEnv
}), _dec(_class = (_temp = _class2 = function (_Component) {
  (0, _inherits3.default)(ProjectEnv, _Component);

  function ProjectEnv(props) {
    (0, _classCallCheck3.default)(this, ProjectEnv);

    var _this = (0, _possibleConstructorReturn3.default)(this, _Component.call(this, props));

    _this.handleClick = function (key, data) {
      _this.setState({
        currentEnvMsg: data,
        currentKey: key
      });
    };

    _this.addParams = function (name, data) {
      var newValue = {};
      data = { name: '新环境', domain: '', header: [] };
      newValue[name] = [].concat(data, _this.state[name]);
      _this.setState(newValue);
      _this.handleClick(0, data);
    };

    _this.delParams = function (key, name) {
      var curValue = _this.state.env;
      var newValue = {};
      newValue[name] = curValue.filter(function (val, index) {
        return index !== key;
      });
      _this.setState(newValue);
      _this.handleClick(0, newValue[name][0]);
      newValue['_id'] = _this.state._id;
      return newValue;
    };

    _this.enterItem = function (key) {
      _this.setState({ delIcon: key });
    };

    _this.onSubmit = function (value, index) {
      var assignValue = {};
      assignValue['env'] = [].concat(_this.state.env);
      assignValue['env'].splice(index, 1, value['env']);
      assignValue['_id'] = _this.state._id;
      _this.onSave(assignValue);
      _this.props.onOk && _this.props.onOk(assignValue['env'], index);
    };

    _this.handleInputChange = function (value, currentKey) {
      var newValue = [].concat(_this.state.env);
      newValue[currentKey].name = value || '新环境';
      _this.setState({ env: newValue });
    };

    _this.handleDragMove = function (name) {
      return function (data, from, to) {
        var _newValue;

        var newValue = (_newValue = {}, _newValue[name] = data, _newValue);
        _this.setState(newValue);
        newValue['_id'] = _this.state._id;
        _this.handleClick(to, newValue[name][to]);
        _this.onSave(newValue);
      };
    };

    _this.state = {
      env: [],
      _id: null,
      currentEnvMsg: {},
      delIcon: null,
      currentKey: -2
    };
    return _this;
  }

  ProjectEnv.prototype.initState = function initState(curdata, id) {
    var newValue = {};
    newValue['env'] = [].concat(curdata);
    newValue['_id'] = id;
    this.setState((0, _extends3.default)({}, this.state, newValue));
  };

  ProjectEnv.prototype.componentWillMount = function () {
    var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {
      var _props$projectMsg, env, _id;

      return _regenerator2.default.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              this._isMounted = true;
              _context.next = 3;
              return this.props.getProject(this.props.projectId);

            case 3:
              _props$projectMsg = this.props.projectMsg, env = _props$projectMsg.env, _id = _props$projectMsg._id;

              this.initState(env, _id);
              this.handleClick(0, env[0]);

            case 6:
            case 'end':
              return _context.stop();
          }
        }
      }, _callee, this);
    }));

    function componentWillMount() {
      return _ref.apply(this, arguments);
    }

    return componentWillMount;
  }();

  ProjectEnv.prototype.componentWillUnmount = function componentWillUnmount() {
    this._isMounted = false;
  };

  // 增加环境变量项


  // 删除提示信息
  ProjectEnv.prototype.showConfirm = function showConfirm(key, name) {
    var assignValue = this.delParams(key, name);
    this.onSave(assignValue);
  };

  // 删除环境变量项


  // 保存设置
  ProjectEnv.prototype.onSave = function () {
    var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(assignValue) {
      var _this2 = this;

      return _regenerator2.default.wrap(function _callee2$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              _context2.next = 2;
              return this.props.updateEnv(assignValue).then(function (res) {
                if (res.payload.data.errcode == 0) {
                  _this2.props.getProject(_this2.props.projectId);
                  _this2.props.getEnv(_this2.props.projectId);
                  _message3.default.success('修改成功! ');
                  if (_this2._isMounted) {
                    _this2.setState((0, _extends3.default)({}, assignValue));
                  }
                }
              }).catch(function () {
                _message3.default.error('环境设置不成功 ');
              });

            case 2:
            case 'end':
              return _context2.stop();
          }
        }
      }, _callee2, this);
    }));

    function onSave(_x) {
      return _ref2.apply(this, arguments);
    }

    return onSave;
  }();

  //  提交保存信息


  // 动态修改环境名称


  // 侧边栏拖拽


  ProjectEnv.prototype.render = function render() {
    var _this3 = this;

    var _state = this.state,
        env = _state.env,
        currentKey = _state.currentKey;


    var envSettingItems = env.map(function (item, index) {
      return _react2.default.createElement(
        _row2.default,
        {
          key: index,
          className: 'menu-item ' + (index === currentKey ? 'menu-item-checked' : ''),
          onClick: function onClick() {
            return _this3.handleClick(index, item);
          },
          onMouseEnter: function onMouseEnter() {
            return _this3.enterItem(index);
          }
        },
        _react2.default.createElement(
          'span',
          { className: 'env-icon-style' },
          _react2.default.createElement(
            'span',
            { className: 'env-name', style: { color: item.name === '新环境' && '#2395f1' } },
            item.name
          ),
          _react2.default.createElement(
            _popconfirm2.default,
            {
              title: '\u60A8\u786E\u8BA4\u5220\u9664\u6B64\u73AF\u5883\u53D8\u91CF?',
              onConfirm: function onConfirm(e) {
                e.stopPropagation();
                _this3.showConfirm(index, 'env');
              },
              okText: '\u786E\u5B9A',
              cancelText: '\u53D6\u6D88'
            },
            _react2.default.createElement(_icon2.default, {
              type: 'delete',
              className: 'interface-delete-icon',
              style: {
                display: _this3.state.delIcon == index && env.length - 1 !== 0 ? 'block' : 'none'
              }
            })
          )
        )
      );
    });

    return _react2.default.createElement(
      'div',
      { className: 'm-env-panel' },
      _react2.default.createElement(
        _layout2.default,
        { className: 'project-env' },
        _react2.default.createElement(
          Sider,
          { width: 195, style: { background: '#fff' } },
          _react2.default.createElement(
            'div',
            { style: { height: '100%', borderRight: 0 } },
            _react2.default.createElement(
              _row2.default,
              { className: 'first-menu-item menu-item' },
              _react2.default.createElement(
                'div',
                { className: 'env-icon-style' },
                _react2.default.createElement(
                  'h3',
                  null,
                  '\u73AF\u5883\u5217\u8868\xA0',
                  _react2.default.createElement(
                    _tooltip2.default,
                    { placement: 'top', title: '\u5728\u8FD9\u91CC\u6DFB\u52A0\u9879\u76EE\u7684\u73AF\u5883\u914D\u7F6E' },
                    _react2.default.createElement(_icon2.default, { type: 'question-circle-o' })
                  )
                ),
                _react2.default.createElement(
                  _tooltip2.default,
                  { title: '\u6DFB\u52A0\u73AF\u5883\u53D8\u91CF' },
                  _react2.default.createElement(_icon2.default, { type: 'plus', onClick: function onClick() {
                      return _this3.addParams('env');
                    } })
                )
              )
            ),
            _react2.default.createElement(
              _EasyDragSort2.default,
              { data: function data() {
                  return env;
                }, onChange: this.handleDragMove('env') },
              envSettingItems
            )
          )
        ),
        _react2.default.createElement(
          _layout2.default,
          { className: 'env-content' },
          _react2.default.createElement(
            Content,
            { style: { background: '#fff', padding: 24, margin: 0, minHeight: 280 } },
            _react2.default.createElement(_ProjectEnvContent2.default, {
              projectMsg: this.state.currentEnvMsg,
              onSubmit: function onSubmit(e) {
                return _this3.onSubmit(e, currentKey);
              },
              handleEnvInput: function handleEnvInput(e) {
                return _this3.handleInputChange(e, currentKey);
              }
            })
          )
        )
      )
    );
  };

  return ProjectEnv;
}(_react.Component), _class2.propTypes = {
  projectId: _propTypes2.default.number,
  updateEnv: _propTypes2.default.func,
  getProject: _propTypes2.default.func,
  projectMsg: _propTypes2.default.object,
  onOk: _propTypes2.default.func,
  getEnv: _propTypes2.default.func
}, _temp)) || _class);
exports.default = ProjectEnv;