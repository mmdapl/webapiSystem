{"version":3,"sources":["exts\\yapi-plugin-import-har\\client.js"],"names":["GenerateSchema","require","transformJsonToSchema","json","jsonData","schemaData","postman","importDataModule","parseUrl","url","URL","parse","checkInterRepeat","interData","obj","arr","item","key","request","method","push","handleReq_query","query","res","length","name","value","handleReq_body_form","body_form","type","handlePath","path","pathname","decodeURIComponent","replace","run","JSON","log","entries","filter","response","content","mimeType","indexOf","interfaceData","apis","bind","data","importHar","e","console","error","reflect","title","desc","req_query","req_body_form","req_body_other","allKey","reqType","header","headers","forEach","test","postData","req_body_is_json_schema","text","substr","res_body_is_json_schema","encoding","har","module","exports","bindHook"],"mappings":"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","file":"client.js","sourceRoot":"C:/Users/DUOYI/Desktop/api/test/vendors","sourcesContent":["import { message } from 'antd';\nimport URL from 'url';\nconst GenerateSchema = require('generate-schema/src/schemas/json.js');\nimport { json_parse, unbase64 } from '../../common/utils.js';\n\nconst transformJsonToSchema = json => {\n  json = json || {};\n  let jsonData = json_parse(json);\n\n  jsonData = GenerateSchema(jsonData);\n\n  let schemaData = JSON.stringify(jsonData);\n\n  return schemaData;\n};\n\nfunction postman(importDataModule) {\n  function parseUrl(url) {\n    return URL.parse(url);\n  }\n\n  function checkInterRepeat(interData) {\n    let obj = {};\n    let arr = [];\n    for (let item in interData) {\n      // console.log(interData[item].url + \"-\" + interData[item].method);\n      let key = interData[item].request.url + '|' + interData[item].request.method;\n      if (!obj[key]) {\n        arr.push(interData[item]);\n        obj[key] = true;\n      }\n    }\n    return arr;\n  }\n\n  function handleReq_query(query) {\n    let res = [];\n    if (query && query.length) {\n      for (let item in query) {\n        res.push({\n          name: query[item].name,\n          value: query[item].value\n        });\n      }\n    }\n    return res;\n  }\n  // function handleReq_headers(headers){\n  //   let res = [];\n  //   if(headers&&headers.length){\n  //     for(let item in headers){\n  //       res.push({\n  //         name: headers[item].key,\n  //         desc: headers[item].description,\n  //         value: headers[item].value,\n  //         required: headers[item].enable\n  //       });\n  //     }\n  //   }\n  //   return res;\n  // }\n\n  function handleReq_body_form(body_form) {\n    let res = [];\n    if (body_form && typeof body_form === 'object') {\n      for (let item in body_form) {\n        res.push({\n          name: body_form[item].name,\n          value: body_form[item].value,\n          type: 'text'\n        });\n      }\n    }\n    return res;\n  }\n\n  function handlePath(path) {\n    path = parseUrl(path).pathname;\n    path = decodeURIComponent(path);\n    if (!path) return '';\n\n    path = path.replace(/{{\\w*}}/g, '');\n\n    if (path[0] != '/') {\n      path = '/' + path;\n    }\n    return path;\n  }\n\n  function run(res) {\n    try {\n      res = JSON.parse(res);\n      res = res.log.entries;\n\n      res = res.filter(item => {\n        if (!item) return false;\n        return item.response.content.mimeType.indexOf('application/json') === 0;\n      });\n\n      let interfaceData = { apis: [] };\n      res = checkInterRepeat.bind(this)(res);\n      if (res && res.length) {\n        for (let item in res) {\n          let data = importHar.bind(this)(res[item]);\n          interfaceData.apis.push(data);\n        }\n      }\n\n      return interfaceData;\n    } catch (e) {\n      console.error(e);\n      message.error('数据格式有误');\n    }\n  }\n\n  function importHar(data, key) {\n    let reflect = {\n      //数据字段映射关系\n      title: 'url',\n      path: 'url',\n      method: 'method',\n      desc: 'description',\n      req_query: 'queryString',\n      req_body_form: 'params',\n      req_body_other: 'text'\n    };\n    let allKey = [\n      'title',\n      'path',\n      'method',\n      'req_query',\n      'req_body_type',\n      'req_body_form',\n      'req_body_other',\n      'res_body_type',\n      'res_body',\n      'req_headers'\n    ];\n    key = key || allKey;\n    let res = {};\n\n    let reqType = 'json',\n      header;\n    data.request.headers.forEach(item => {\n      if (!item || !item.name || !item.value) return null;\n      if (/content-type/i.test(item.name) && item.value.indexOf('application/json') === 0) {\n        reqType = 'json';\n        header = 'application/json';\n      } else if (\n        /content-type/i.test(item.name) &&\n        item.value.indexOf('application/x-www-form-urlencoded') === 0\n      ) {\n        header = 'application/x-www-form-urlencoded';\n        reqType = 'form';\n      } else if (\n        /content-type/i.test(item.name) &&\n        item.value.indexOf('multipart/form-data') === 0\n      ) {\n        header = 'multipart/form-data';\n        reqType = 'form';\n      }\n    });\n\n    for (let item in key) {\n      item = key[item];\n      if (item === 'req_query') {\n        res[item] = handleReq_query.bind(this)(data.request[reflect[item]]);\n      } else if (item === 'req_body_form' && reqType === 'form' && data.request.postData) {\n        if (header === 'application/x-www-form-urlencoded') {\n          res[item] = handleReq_body_form.bind(this)(data.request.postData[reflect[item]]);\n        } else if (header === 'multipart/form-data') {\n          res[item] = [];\n        }\n      } else if (item === 'req_body_other' && reqType === 'json' && data.request.postData) {\n        res.req_body_is_json_schema = true;\n        res[item] = transformJsonToSchema(data.request.postData.text);\n      } else if (item === 'req_headers') {\n        res[item] = [\n          {\n            name: 'Content-Type',\n            value: header\n          }\n        ];\n      } else if (item === 'req_body_type') {\n        res[item] = reqType;\n      } else if (item === 'path') {\n        res[item] = handlePath.bind(this)(data.request[reflect[item]]);\n      } else if (item === 'title') {\n        let path = handlePath.bind(this)(data.request[reflect['path']]);\n        if (data.request[reflect[item]].indexOf(path) > -1) {\n          res[item] = path;\n          if (res[item] && res[item].indexOf('/:') > -1) {\n            res[item] = res[item].substr(0, res[item].indexOf('/:'));\n          }\n        } else {\n          res[item] = data.request[reflect[item]];\n        }\n      } else if (item === 'res_body_type') {\n        res[item] = 'json';\n      } else if (item === 'res_body') {\n        res.res_body_is_json_schema = true;\n        if (data.response.content.encoding && data.response.content.encoding == 'base64') {\n            //base64\n            res[item] = transformJsonToSchema(unbase64(data.response.content.text));\n        } else {\n            res[item] = transformJsonToSchema(data.response.content.text);\n        }\n      } else {\n        res[item] = data.request[reflect[item]];\n      }\n    }\n    return res;\n  }\n\n  if (!importDataModule || typeof importDataModule !== 'object') {\n    console.error('obj参数必需是一个对象');\n    return null;\n  }\n\n  importDataModule.har = {\n    name: 'HAR',\n    run: run,\n    desc: '使用chrome录制请求功能，具体使用请查看文档'\n  };\n}\n\nmodule.exports = function() {\n  this.bindHook('import_data', postman);\n};\n"]}