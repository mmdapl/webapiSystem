'use strict';

exports.__esModule = true;
exports.default = undefined;

var _getOwnPropertyDescriptor = require('babel-runtime/core-js/object/get-own-property-descriptor');

var _getOwnPropertyDescriptor2 = _interopRequireDefault(_getOwnPropertyDescriptor);

var _modal = require('antd/lib/modal');

var _modal2 = _interopRequireDefault(_modal);

var _row = require('antd/lib/row');

var _row2 = _interopRequireDefault(_row);

var _col = require('antd/lib/col');

var _col2 = _interopRequireDefault(_col);

var _menu = require('antd/lib/menu');

var _menu2 = _interopRequireDefault(_menu);

var _popover = require('antd/lib/popover');

var _popover2 = _interopRequireDefault(_popover);

var _spin = require('antd/lib/spin');

var _spin2 = _interopRequireDefault(_spin);

var _tooltip = require('antd/lib/tooltip');

var _tooltip2 = _interopRequireDefault(_tooltip);

var _icon = require('antd/lib/icon');

var _icon2 = _interopRequireDefault(_icon);

var _message2 = require('antd/lib/message');

var _message3 = _interopRequireDefault(_message2);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _input = require('antd/lib/input');

var _input2 = _interopRequireDefault(_input);

var _dec, _class, _desc, _value, _class2, _class3, _temp;

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _reactRedux = require('react-redux');

var _coreDecorators = require('core-decorators');

var _axios = require('axios');

var _axios2 = _interopRequireDefault(_axios);

var _reactRouterDom = require('react-router-dom');

var _UsernameAutoComplete = require('../../../components/UsernameAutoComplete/UsernameAutoComplete.js');

var _UsernameAutoComplete2 = _interopRequireDefault(_UsernameAutoComplete);

var _GuideBtns = require('../../../components/GuideBtns/GuideBtns.js');

var _GuideBtns2 = _interopRequireDefault(_GuideBtns);

var _news = require('../../../reducer/modules/news.js');

var _group = require('../../../reducer/modules/group.js');

var _underscore = require('underscore');

var _underscore2 = _interopRequireDefault(_underscore);

require('./GroupList.scss');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _applyDecoratedDescriptor(target, property, decorators, descriptor, context) {
  var desc = {};
  Object['ke' + 'ys'](descriptor).forEach(function (key) {
    desc[key] = descriptor[key];
  });
  desc.enumerable = !!desc.enumerable;
  desc.configurable = !!desc.configurable;

  if ('value' in desc || desc.initializer) {
    desc.writable = true;
  }

  desc = decorators.slice().reverse().reduce(function (desc, decorator) {
    return decorator(target, property, desc) || desc;
  }, desc);

  if (context && desc.initializer !== void 0) {
    desc.value = desc.initializer ? desc.initializer.call(context) : void 0;
    desc.initializer = undefined;
  }

  if (desc.initializer === void 0) {
    Object['define' + 'Property'](target, property, desc);
    desc = null;
  }

  return desc;
}

var TextArea = _input2.default.TextArea;

var Search = _input2.default.Search;


var tip = _react2.default.createElement(
  'div',
  { className: 'title-container' },
  _react2.default.createElement(
    'h3',
    { className: 'title' },
    '\u6B22\u8FCE\u4F7F\u7528 YApi ~'
  ),
  _react2.default.createElement(
    'p',
    null,
    '\u8FD9\u91CC\u7684 ',
    _react2.default.createElement(
      'b',
      null,
      '\u201C\u4E2A\u4EBA\u7A7A\u95F4\u201D'
    ),
    ' ',
    '\u662F\u4F60\u81EA\u5DF1\u624D\u80FD\u770B\u5230\u7684\u5206\u7EC4\uFF0C\u4F60\u62E5\u6709\u8FD9\u4E2A\u5206\u7EC4\u7684\u5168\u90E8\u6743\u9650\uFF0C\u53EF\u4EE5\u5728\u8FD9\u4E2A\u5206\u7EC4\u91CC\u63A2\u7D22 YApi \u7684\u529F\u80FD\u3002'
  )
);

var GroupList = (_dec = (0, _reactRedux.connect)(function (state) {
  return {
    groupList: state.group.groupList,
    currGroup: state.group.currGroup,
    curUserRole: state.user.role,
    curUserRoleInGroup: state.group.currGroup.role || state.group.role,
    studyTip: state.user.studyTip,
    study: state.user.study
  };
}, {
  fetchGroupList: _group.fetchGroupList,
  setCurrGroup: _group.setCurrGroup,
  setGroupList: _group.setGroupList,
  fetchNewsData: _news.fetchNewsData,
  fetchGroupMsg: _group.fetchGroupMsg
}), _dec(_class = (0, _reactRouterDom.withRouter)(_class = (_class2 = (_temp = _class3 = function (_Component) {
  (0, _inherits3.default)(GroupList, _Component);

  function GroupList(props) {
    (0, _classCallCheck3.default)(this, GroupList);

    var _this = (0, _possibleConstructorReturn3.default)(this, _Component.call(this, props));

    _this.state = {
      addGroupModalVisible: false,
      newGroupName: '',
      newGroupDesc: '',
      currGroupName: '',
      currGroupDesc: '',
      groupList: [],
      owner_uids: []
    };
    return _this;
  }

  GroupList.prototype.componentWillMount = function () {
    var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {
      var groupId, currGroup, i;
      return _regenerator2.default.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              groupId = !isNaN(this.props.match.params.groupId) ? parseInt(this.props.match.params.groupId) : 0;
              _context.next = 3;
              return this.props.fetchGroupList();

            case 3:
              currGroup = false;

              if (this.props.groupList.length && groupId) {
                for (i = 0; i < this.props.groupList.length; i++) {
                  if (this.props.groupList[i]._id === groupId) {
                    currGroup = this.props.groupList[i];
                  }
                }
              } else if (!groupId && this.props.groupList.length) {
                this.props.history.push('/group/' + this.props.groupList[0]._id);
              }
              if (!currGroup) {
                currGroup = this.props.groupList[0] || { group_name: '', group_desc: '' };
                this.props.history.replace('' + currGroup._id);
              }
              this.setState({ groupList: this.props.groupList });
              this.props.setCurrGroup(currGroup);

            case 8:
            case 'end':
              return _context.stop();
          }
        }
      }, _callee, this);
    }));

    function componentWillMount() {
      return _ref.apply(this, arguments);
    }

    return componentWillMount;
  }();

  GroupList.prototype.showModal = function showModal() {
    this.setState({
      addGroupModalVisible: true
    });
  };

  GroupList.prototype.hideModal = function hideModal() {
    this.setState({
      newGroupName: '',
      group_name: '',
      owner_uids: [],
      addGroupModalVisible: false
    });
  };

  GroupList.prototype.addGroup = function () {
    var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {
      var _state, group_name, group_desc, owner_uids, res;

      return _regenerator2.default.wrap(function _callee2$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              _state = this.state, group_name = _state.newGroupName, group_desc = _state.newGroupDesc, owner_uids = _state.owner_uids;
              _context2.next = 3;
              return _axios2.default.post('/api/group/add', { group_name: group_name, group_desc: group_desc, owner_uids: owner_uids });

            case 3:
              res = _context2.sent;

              if (res.data.errcode) {
                _context2.next = 13;
                break;
              }

              this.setState({
                newGroupName: '',
                group_name: '',
                owner_uids: [],
                addGroupModalVisible: false
              });
              _context2.next = 8;
              return this.props.fetchGroupList();

            case 8:
              this.setState({ groupList: this.props.groupList });
              this.props.fetchGroupMsg(this.props.currGroup._id);
              this.props.fetchNewsData(this.props.currGroup._id, 'group', 1, 10);
              _context2.next = 14;
              break;

            case 13:
              _message3.default.error(res.data.errmsg);

            case 14:
            case 'end':
              return _context2.stop();
          }
        }
      }, _callee2, this);
    }));

    function addGroup() {
      return _ref2.apply(this, arguments);
    }

    return addGroup;
  }();

  GroupList.prototype.editGroup = function () {
    var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3() {
      var _state2, group_name, group_desc, id, res, currGroup;

      return _regenerator2.default.wrap(function _callee3$(_context3) {
        while (1) {
          switch (_context3.prev = _context3.next) {
            case 0:
              _state2 = this.state, group_name = _state2.currGroupName, group_desc = _state2.currGroupDesc;
              id = this.props.currGroup._id;
              _context3.next = 4;
              return _axios2.default.post('/api/group/up', { group_name: group_name, group_desc: group_desc, id: id });

            case 4:
              res = _context3.sent;

              if (!res.data.errcode) {
                _context3.next = 9;
                break;
              }

              _message3.default.error(res.data.errmsg);
              _context3.next = 16;
              break;

            case 9:
              _context3.next = 11;
              return this.props.fetchGroupList();

            case 11:

              this.setState({ groupList: this.props.groupList });
              currGroup = _underscore2.default.find(this.props.groupList, function (group) {
                return +group._id === +id;
              });


              this.props.setCurrGroup(currGroup);
              // this.props.setCurrGroup({ group_name, group_desc, _id: id });
              this.props.fetchGroupMsg(this.props.currGroup._id);
              this.props.fetchNewsData(this.props.currGroup._id, 'group', 1, 10);

            case 16:
            case 'end':
              return _context3.stop();
          }
        }
      }, _callee3, this);
    }));

    function editGroup() {
      return _ref3.apply(this, arguments);
    }

    return editGroup;
  }();

  GroupList.prototype.inputNewGroupName = function inputNewGroupName(e) {
    this.setState({ newGroupName: e.target.value });
  };

  GroupList.prototype.inputNewGroupDesc = function inputNewGroupDesc(e) {
    this.setState({ newGroupDesc: e.target.value });
  };

  GroupList.prototype.selectGroup = function selectGroup(e) {
    var groupId = e.key;
    //const currGroup = this.props.groupList.find((group) => { return +group._id === +groupId });
    var currGroup = _underscore2.default.find(this.props.groupList, function (group) {
      return +group._id === +groupId;
    });
    this.props.setCurrGroup(currGroup);
    this.props.history.replace('' + currGroup._id);
    this.props.fetchNewsData(groupId, 'group', 1, 10);
  };

  GroupList.prototype.onUserSelect = function onUserSelect(uids) {
    this.setState({
      owner_uids: uids
    });
  };

  GroupList.prototype.searchGroup = function searchGroup(e, value) {
    var v = value || e.target.value;
    var groupList = this.props.groupList;

    if (v === '') {
      this.setState({ groupList: groupList });
    } else {
      this.setState({
        groupList: groupList.filter(function (group) {
          return new RegExp(v, 'i').test(group.group_name);
        })
      });
    }
  };

  GroupList.prototype.componentWillReceiveProps = function componentWillReceiveProps(nextProps) {
    // GroupSetting 组件设置的分组信息，通过redux同步到左侧分组菜单中
    if (this.props.groupList !== nextProps.groupList) {
      this.setState({
        groupList: nextProps.groupList
      });
    }
  };

  GroupList.prototype.render = function render() {
    var _this2 = this;

    var currGroup = this.props.currGroup;

    return _react2.default.createElement(
      'div',
      { className: 'm-group' },
      !this.props.study ? _react2.default.createElement('div', { className: 'study-mask' }) : null,
      _react2.default.createElement(
        'div',
        { className: 'group-bar' },
        _react2.default.createElement(
          'div',
          { className: 'curr-group' },
          _react2.default.createElement(
            'div',
            { className: 'curr-group-name' },
            _react2.default.createElement(
              'span',
              { className: 'name' },
              currGroup.group_name
            ),
            _react2.default.createElement(
              _tooltip2.default,
              { title: '\u6DFB\u52A0\u5206\u7EC4' },
              _react2.default.createElement(
                'a',
                { className: 'editSet' },
                _react2.default.createElement(_icon2.default, { className: 'btn', type: 'folder-add', onClick: this.showModal })
              )
            )
          ),
          _react2.default.createElement(
            'div',
            { className: 'curr-group-desc' },
            '\u7B80\u4ECB: ',
            currGroup.group_desc
          )
        ),
        _react2.default.createElement(
          'div',
          { className: 'group-operate' },
          _react2.default.createElement(
            'div',
            { className: 'search' },
            _react2.default.createElement(Search, {
              placeholder: '\u641C\u7D22\u5206\u7C7B',
              onChange: this.searchGroup,
              onSearch: function onSearch(v) {
                return _this2.searchGroup(null, v);
              }
            })
          )
        ),
        this.state.groupList.length === 0 && _react2.default.createElement(_spin2.default, { style: {
            marginTop: 20,
            display: 'flex',
            justifyContent: 'center'
          } }),
        _react2.default.createElement(
          _menu2.default,
          {
            className: 'group-list',
            mode: 'inline',
            onClick: this.selectGroup,
            selectedKeys: ['' + currGroup._id]
          },
          this.state.groupList.map(function (group) {
            if (group.type === 'private') {
              return _react2.default.createElement(
                _menu2.default.Item,
                {
                  key: '' + group._id,
                  className: 'group-item',
                  style: { zIndex: _this2.props.studyTip === 0 ? 3 : 1 }
                },
                _react2.default.createElement(_icon2.default, { type: 'user' }),
                _react2.default.createElement(
                  _popover2.default,
                  {
                    overlayClassName: 'popover-index',
                    content: _react2.default.createElement(_GuideBtns2.default, null),
                    title: tip,
                    placement: 'right',
                    visible: _this2.props.studyTip === 0 && !_this2.props.study
                  },
                  group.group_name
                )
              );
            } else {
              return _react2.default.createElement(
                _menu2.default.Item,
                { key: '' + group._id, className: 'group-item' },
                _react2.default.createElement(_icon2.default, { type: 'folder-open' }),
                group.group_name
              );
            }
          })
        )
      ),
      this.state.addGroupModalVisible ? _react2.default.createElement(
        _modal2.default,
        {
          title: '\u6DFB\u52A0\u5206\u7EC4',
          visible: this.state.addGroupModalVisible,
          onOk: this.addGroup,
          onCancel: this.hideModal,
          className: 'add-group-modal'
        },
        _react2.default.createElement(
          _row2.default,
          { gutter: 6, className: 'modal-input' },
          _react2.default.createElement(
            _col2.default,
            { span: '5' },
            _react2.default.createElement(
              'div',
              { className: 'label' },
              '\u5206\u7EC4\u540D\uFF1A'
            )
          ),
          _react2.default.createElement(
            _col2.default,
            { span: '15' },
            _react2.default.createElement(_input2.default, { placeholder: '\u8BF7\u8F93\u5165\u5206\u7EC4\u540D\u79F0', onChange: this.inputNewGroupName })
          )
        ),
        _react2.default.createElement(
          _row2.default,
          { gutter: 6, className: 'modal-input' },
          _react2.default.createElement(
            _col2.default,
            { span: '5' },
            _react2.default.createElement(
              'div',
              { className: 'label' },
              '\u7B80\u4ECB\uFF1A'
            )
          ),
          _react2.default.createElement(
            _col2.default,
            { span: '15' },
            _react2.default.createElement(TextArea, { rows: 3, placeholder: '\u8BF7\u8F93\u5165\u5206\u7EC4\u63CF\u8FF0', onChange: this.inputNewGroupDesc })
          )
        ),
        _react2.default.createElement(
          _row2.default,
          { gutter: 6, className: 'modal-input' },
          _react2.default.createElement(
            _col2.default,
            { span: '5' },
            _react2.default.createElement(
              'div',
              { className: 'label' },
              '\u7EC4\u957F\uFF1A'
            )
          ),
          _react2.default.createElement(
            _col2.default,
            { span: '15' },
            _react2.default.createElement(_UsernameAutoComplete2.default, { callbackState: this.onUserSelect })
          )
        )
      ) : ''
    );
  };

  return GroupList;
}(_react.PureComponent), _class3.propTypes = {
  groupList: _propTypes2.default.array,
  currGroup: _propTypes2.default.object,
  fetchGroupList: _propTypes2.default.func,
  setCurrGroup: _propTypes2.default.func,
  setGroupList: _propTypes2.default.func,
  match: _propTypes2.default.object,
  history: _propTypes2.default.object,
  curUserRole: _propTypes2.default.string,
  curUserRoleInGroup: _propTypes2.default.string,
  studyTip: _propTypes2.default.number,
  study: _propTypes2.default.bool,
  fetchNewsData: _propTypes2.default.func,
  fetchGroupMsg: _propTypes2.default.func
}, _temp), (_applyDecoratedDescriptor(_class2.prototype, 'showModal', [_coreDecorators.autobind], (0, _getOwnPropertyDescriptor2.default)(_class2.prototype, 'showModal'), _class2.prototype), _applyDecoratedDescriptor(_class2.prototype, 'hideModal', [_coreDecorators.autobind], (0, _getOwnPropertyDescriptor2.default)(_class2.prototype, 'hideModal'), _class2.prototype), _applyDecoratedDescriptor(_class2.prototype, 'addGroup', [_coreDecorators.autobind], (0, _getOwnPropertyDescriptor2.default)(_class2.prototype, 'addGroup'), _class2.prototype), _applyDecoratedDescriptor(_class2.prototype, 'editGroup', [_coreDecorators.autobind], (0, _getOwnPropertyDescriptor2.default)(_class2.prototype, 'editGroup'), _class2.prototype), _applyDecoratedDescriptor(_class2.prototype, 'inputNewGroupName', [_coreDecorators.autobind], (0, _getOwnPropertyDescriptor2.default)(_class2.prototype, 'inputNewGroupName'), _class2.prototype), _applyDecoratedDescriptor(_class2.prototype, 'inputNewGroupDesc', [_coreDecorators.autobind], (0, _getOwnPropertyDescriptor2.default)(_class2.prototype, 'inputNewGroupDesc'), _class2.prototype), _applyDecoratedDescriptor(_class2.prototype, 'selectGroup', [_coreDecorators.autobind], (0, _getOwnPropertyDescriptor2.default)(_class2.prototype, 'selectGroup'), _class2.prototype), _applyDecoratedDescriptor(_class2.prototype, 'onUserSelect', [_coreDecorators.autobind], (0, _getOwnPropertyDescriptor2.default)(_class2.prototype, 'onUserSelect'), _class2.prototype), _applyDecoratedDescriptor(_class2.prototype, 'searchGroup', [_coreDecorators.autobind], (0, _getOwnPropertyDescriptor2.default)(_class2.prototype, 'searchGroup'), _class2.prototype)), _class2)) || _class) || _class);
exports.default = GroupList;